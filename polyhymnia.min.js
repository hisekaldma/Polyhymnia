var Polyhymnia=Polyhymnia||{};Polyhymnia.templates={player:'<div class="polyhymnia-player">    <div class="code" contenteditable></div>    <div class="controls">      <button class="play">     <svg x="0px" y="0px" width="18px" height="18px">       <path fill="none" stroke="#FF884D" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M16,9L2,17V1L16,9z"/>     </svg>     </button>      <button class="stop" style="display: none">       <svg x="0px" y="0px" width="18px" height="18px">         <rect x="2" y="2" fill="none" stroke="#FF884D" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" width="14" height="14"/>       </svg>     </button>      <div class="slider">       <div class="output hide">x = 0</div>       <input type="range" min="0" max="1" value="0" step="0.01" />     </div>   </div>    <div class="error" style="display: none"></div>    <div class="not-supported" style="display: none">     Your browser doesn’t support web audio. Why don’t you try <a href="https://www.google.com/chrome/browser/desktop/">Chrome</a>?   </div> </div>'};var Polyhymnia=Polyhymnia||{};Polyhymnia.Generator=function(){"use strict";function a(b){var c={name:b.name,definitions:[]};return b.definitions.forEach(function(b){if(b.sequence){for(var d=[],e=0;e<b.sequence.length;e++){var f=h[b.sequence[e]];d.push(a(f))}c.definitions.push({condition:b.condition,sequence:d,index:0})}else b.pattern&&c.definitions.push({condition:b.condition,pattern:b.pattern,instrument:b.instrument})}),c}function b(a){var c=!0;return a.definitions.forEach(function(a){if(a.sequence){var d=a.sequence[a.index],e=b(d);e&&a.index++,a.index>=a.sequence.length?a.index=0:c=!1}else a.pattern}),c}function c(a){var b=d(a.definitions),e=[];return b.forEach(function(a){if(a.sequence){var b=c(a.sequence[a.index]);b.forEach(function(a){e.push(a)})}else a.pattern&&e.push({instrument:a.instrument,pattern:a.pattern})}),e}function d(a){var b=[];return a.forEach(function(a){var c=a.condition;if(c){var d=e.getParam(c.param),f=void 0!==c.min?c.min:-1/0,g=void 0!==c.max?c.max:1/0;d>=f&&g>d&&b.push(a)}else b.push(a)}),b}var e=this;this.instruments={};var f="Play",g={},h=null,i=null;this.setParam=function(a,b){g[a]=b},this.getParam=function(a){return g[a]||0},this.getPatterns=function(){return c(i)},this.step=function(){b(i)},this.setRules=function(b){if(!b||0===b.length)throw new Error("No rules to play");for(var c=!1,d=0;d<b.length;d++)b[d].name==f&&(c=!0);if(!c)throw new Error("There is no rule named '"+f+"'");h={};for(var e=0;e<b.length;e++)h[b[e].name]=b[e];i=a(h[f])}};var Polyhymnia=Polyhymnia||{};Polyhymnia.noteType={PAUSE:"pause",NOTE:"note",CHORD:"chord",DRUM:"drum"},Polyhymnia.parse=function(a){"use strict";function b(a){var b=new Error(a);return b.start=l?l.start:0,b.end=l?l.end:0,b}function c(){l=p.length>0?p.shift():void 0,m=p.length>0?p[0]:void 0}function d(){for(;l&&l.type==n.EOL;)c()}function e(){return l?l.type==n.EOL?!0:l.type==n.NAME&&m&&m.type==n.SINGLE_ARROW?!0:!1:!0}function f(){var a="";if(l.type!=n.NAME)throw b("Rules must start with a name");a=l.value,c();var d;if(!l||l.type!==n.SINGLE_ARROW)throw b("Expected ->");c(),l&&l.type==n.EOL&&c();var f=[];do f.push(g()),c();while(!e());return{type:d,name:a,definitions:f}}function g(){if(void 0===l)throw b("Expected a sequence or pattern");var a;if(l.type==n.LEFT_PAREN&&(a=k()),l&&l.type==n.INSTRUMENT){var c=i();return{condition:a,instrument:c.instrument,pattern:c.pattern}}if(l&&l.type==n.NAME){var d=h();return{condition:a,sequence:d}}throw b("Expected a sequence or pattern")}function h(){for(var a=[];l&&l.type!==n.EOL;){if(l.type!=n.NAME)throw b("Expected a rule name");a.push(l.value),c()}return a}function i(){var a;if(!l||l.type!=n.INSTRUMENT)throw b("Expected an instrument name");a=l.value,c();for(var d=[];l&&l.type!==n.EOL;)d.push(j());return{instrument:a,pattern:d}}function j(){var a,d="",e=l.start,f=l.end;if(l.type==n.NOTE)a=o.NOTE,d=l.value;else if(l.type==n.CHORD)a=o.CHORD,d=l.value;else if(l.type==n.DRUM_TRIGGER)a=o.DRUM,d=l.value;else{if(l.type!=n.PAUSE)throw b("Expected a note, chord, drum symbol or pause");a=o.PAUSE}return c(),{type:a,value:d,start:e,end:f}}function k(){if(l.type!=n.LEFT_PAREN)throw b("Expected (");c();var a,d,e;if(l.type==n.PARAM)if(e=l.value,c(),l.type==n.GREATER_THAN){if(c(),l.type!=n.NUMBER)throw b("Expected a number");a=l.value,c()}else{if(l.type!=n.LESS_THAN)throw b("Expected < or >");if(c(),l.type!=n.NUMBER)throw b("Expected a number");d=l.value,c()}else{if(l.type!=n.NUMBER)throw b("Expected a parameter or number");var f=l.value;if(c(),l.type==n.GREATER_THAN){if(d=f,c(),l.type!=n.PARAM)throw b("Expected a parameter");if(e=l.value,c(),l.type==n.GREATER_THAN){if(c(),l.type!=n.NUMBER)throw b("Expected a number");a=l.value,c()}}else{if(l.type!=n.LESS_THAN)throw b("Expected < or >");if(a=f,c(),l.type!=n.PARAM)throw b("Expected a parameter");if(e=l.value,c(),l.type==n.LESS_THAN){if(c(),l.type!=n.NUMBER)throw b("Expected a number");d=l.value,c()}}}if(l.type!=n.RIGHT_PAREN)throw b("Expected )");return c(),{param:e,min:a,max:d}}var l,m,n=Polyhymnia.tokenType,o=Polyhymnia.noteType,p=a.slice(0),q=[];for(c(),d();l;)q.push(f()),d();for(var r=0;r<q.length;r++)for(var s=q[r],t=0;t<s.definitions.length;t++){var u=s.definitions[t].sequence;if(u)for(var v=0;v<u.length;v++){for(var w=u[v],x=!1,y=0;y<q.length;y++)q[y].name==w&&(x=!0);if(!x)throw new Error("There is no rule "+w)}}return q};var Polyhymnia=Polyhymnia||{};Polyhymnia.tokenType={NAME:"name",NUMBER:"number",INSTRUMENT:"instrument",PAUSE:"pause",NOTE:"note",CHORD:"chord",DRUM_TRIGGER:"drum trigger",SINGLE_ARROW:"single arrow",DOUBLE_ARROW:"double arrow",LEFT_PAREN:"left paren",RIGHT_PAREN:"right paren",PARAM:"param",LESS_THAN:"less than",GREATER_THAN:"greater than",COMMENT:"comment",ERROR:"error",EOL:"eol"},Polyhymnia.tokenize=function(a){"use strict";function b(){D++,d=D<z.length,d&&(e=z[D],C++)}function c(){for(var a="";d&&-1===q.indexOf(e);)a+=e,b();return a}var d,e,f=Polyhymnia.tokenType,g="[A-Z][a-zA-Z0-9_]+",h="[a-z][a-zA-Z0-9_]*",i=g+":",j="-?(([1-9][0-9]*)|0)\\.[0-9]+",k="[CDEFGAB][#b]?",l=k+"(M|m|dom|aug|dim)7?",m="[xX]",n="\n",o=" ",p="	",q="()\n	 ",r=new RegExp("^"+g+"$"),s=new RegExp("^"+h+"$"),t=new RegExp("^"+i+"$"),u=new RegExp("^"+j+"$"),v=new RegExp("^"+k+"$"),w=new RegExp("^"+l+"$"),x=new RegExp("^"+m+"$"),y=a.replace("\r",""),z=y.split(""),A=[],B=1,C=-1,D=-1;b();for(var E,F,G,H,I=0;d;)H=void 0,E=void 0,F=B,G=C,e==n?(B++,E={type:f.EOL},b()):e==o||e==p?b():"("==e?(E={type:f.LEFT_PAREN},I++,b()):")"==e?(E={type:f.RIGHT_PAREN},I--,b()):(H=c(),E=I>0&&H.match(s)?{type:f.PARAM,value:H}:"->"==H?{type:f.SINGLE_ARROW}:"=>"==H?{type:f.DOUBLE_ARROW}:">"==H?{type:f.GREATER_THAN}:"<"==H?{type:f.LESS_THAN}:"_"==H?{type:f.PAUSE}:H.match(x)?{type:f.DRUM_TRIGGER,value:H}:H.match(v)?{type:f.NOTE,value:H}:H.match(w)?{type:f.CHORD,value:H}:H.match(t)?{type:f.INSTRUMENT,value:H.substr(0,H.length-1)}:H.match(u)?{type:f.NUMBER,value:H}:H.match(r)?{type:f.NAME,value:H}:H.match(s)?{type:f.PARAM,value:H}:{type:f.ERROR,value:H}),void 0!==E&&(E.line=F,E.start=G,E.end=H?G+H.length:G+1,A.push(E));return A};var Polyhymnia=Polyhymnia||{};Polyhymnia.Chords=function(){"use strict";var a={};return a.chords={M:[0,4,7],m:[0,3,7],M7:[0,4,7,11],m7:[0,3,7,10],dom7:[0,4,7,10],aug:[0,4,8],aug7:[0,4,8,10],dim:[0,3,6],dim7:[0,3,6,9]},a.toName=function(b){b.forEach(function(a,c){b[c]=a%12});for(var c in a.chords){var d=a.chords[c];if(d.length==b.length){for(var e=!0,f=0;f<d.length;f++)d[f]!=b[f]&&(e=!1);if(e)return c}}return""},a.fromName=function(b){return b in a.chords?a.chords[b]:[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Notes=function(){"use strict";var a={};return a.notes={C:0,"B#":0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11},a.notesReverse={0:"C",1:"C#",2:"D",3:"D#",4:"E",5:"F",6:"F#",7:"G",8:"G#",9:"A",10:"A#",11:"B"},a.toName=function(b){return a.notesReverse[b%12]},a.fromName=function(b,c){return c?c+=2:c=5,b in a.notes?a.notes[b]+12*c:0},a.toFrequency=function(a){return 440*Math.pow(2,(a-69)/12)},a.fromFrequency=function(a){return Math.round(69+12*Math.log(.0022727272727*a)/Math.LN2)},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Scales=function(){"use strict";var a={};return a.scales={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],"pentatonic-major":[0,2,4,7,9],"pentatonic-minor":[0,3,5,7,10]},a.toName=function(b){b.forEach(function(a,c){b[c]=a%12});for(var c in a.scales){var d=a.scales[c];if(d.length==b.length){for(var e=!0,f=0;f<d.length;f++)d[f]!=b[f]&&(e=!1);if(e)return c}}return""},a.fromName=function(b){return b in a.scales?a.scales[b]:[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Player=function(a,b){"use strict";function c(){try{var a=u.textContent,b=Polyhymnia.tokenize(a),c=Polyhymnia.parse(b);o.setRules(c),o.play(),q.style.display="none",r.style.display="block",v.style.display="none",i(c)}catch(d){if(v.textContent=d.message,v.style.display="block",!d.start||!d.end)throw d;k(d)}}function d(){o.stop(),q.style.display="block",r.style.display="none",j()}function e(a){if(13===a.keyCode){var b=m()==u.textContent.length;document.execCommand("insertHTML",!1,"\n"),b&&document.execCommand("insertHTML",!1,"\n"),a.preventDefault()}}function f(){setTimeout(function(){var a=u.innerHTML;a=a.replace(/<br.*?>/g,"\n"),u.innerHTML=a,j()},1)}function g(){o.setParam("x",s.value),t.textContent="x = "+s.value,t.classList.remove("hide"),t.classList.add("show");var a=s.value/(s.max-s.min),b=8*(1-a)-8*a;t.style.left=a*s.offsetWidth-t.offsetWidth/2+b+"px"}function h(){t.classList.add("hide"),t.classList.remove("show")}function i(a){for(var b=u.textContent,c=[],d=0;d<a.length;d++)for(var e=0;e<a[d].definitions.length;e++){var f=a[d].definitions[e].pattern;f&&(c=c.concat(f))}var g="";if(c.length>0)for(var h=0,i=0;i<b.length;i++)c[h]&&c[h].start==i&&(g+='<span class="note" data-start="'+c[h].start+'">'),g+=b.charAt(i),c[h]&&c[h].end==i+1&&(g+="</span>",h++);u.innerHTML=g,x=[];for(var j=u.querySelectorAll(".note"),k=0;k<j.length;k++)x.push({elem:j[k],start:j[k].dataset.start})}function j(){u.innerHTML=u.textContent}function k(a){for(var b=u.textContent,c="",d=0;d<b.length;d++)d==a.start?c+='<span class="error-highlight">':d==a.end&&(c+="</span>"),c+=b.charAt(d);u.innerHTML=c}function l(a){for(var b=0;b<x.length;b++){for(var c=!1,d=0;d<a.length;d++)x[b].start==a[d].start&&(c=!0);x[b].elem.className=c?"playing":"note"}}function m(){var a=window.getSelection().getRangeAt(0),b=a.cloneRange();return b.selectNodeContents(u),b.setEnd(a.endContainer,a.endOffset),b.toString().length}var n=a.textContent,o=b;o.setAnimCallback(l),a.innerHTML=Polyhymnia.templates.player;var p=a.querySelector(".controls"),q=a.querySelector(".play"),r=a.querySelector(".stop"),s=a.querySelector(".slider input"),t=a.querySelector(".slider .output"),u=a.querySelector(".code"),v=a.querySelector(".error"),w=a.querySelector(".not-supported"),x=[];u.textContent=n,Polyhymnia.isSupported()?(q.addEventListener("click",c),r.addEventListener("click",d),s.addEventListener("input",g),s.addEventListener("change",h),u.addEventListener("keydown",e),a.addEventListener("paste",f)):(p.style.display="none",w.style.display="block")};var Polyhymnia=Polyhymnia||{};Polyhymnia.Metronome=function(){"use strict";function a(){if(!document.hidden)for(;f<h.currentTime+c.lookahead;)c.sequencer.scheduleStep(e,f),b();g=window.setTimeout(a,c.interval)}function b(){var a=60/c.tempo;f+=a/c.stepsPerBeat,e++}var c=this;this.tempo=120,this.stepsPerBeat=16,this.interval=25,this.lookahead=.1,this.sequencer=null;var d=!1,e=0,f=0,g=0,h=Polyhymnia.getAudioContext();this.play=function(){d||(e=0,f=h.currentTime,a(),d=!0)},this.stop=function(){d&&(window.clearTimeout(g),d=!1)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Sampler=function(a){"use strict";function b(a,b){var d=new XMLHttpRequest;d.open("GET",b,!0),d.responseType="arraybuffer",d.onload=function(){e.decodeAudioData(d.response,function(d){console.log("Loaded "+b),g[a]=d,h++,h==i&&c()},function(){console.log("Error decoding audio file: "+b)})},d.send()}function c(){for(var a=0;128>a;a++)if(void 0!==g[a])f[a]={buffer:g[a],pitch:1};else{for(var b,c,d=0;a>d;d++)g[d]&&(b=d);for(var e=127;e>a;e--)g[e]&&(c=e);var h;if(c&&b?h=a-b>c-a?c:b:c?h=c:b&&(h=b),h){var i=Polyhymnia.Notes.toFrequency(a),j=Polyhymnia.Notes.toFrequency(h),k=i/j;f[a]={buffer:g[h],pitch:k,orig:h}}}}var d=this,e=Polyhymnia.getAudioContext(),f=[],g=[],h=0,i=0;if(a&&a.samples){i=a.samples.length;for(var j=0;j<a.samples.length;j++){var k=a.samples[j].root||"C",l=a.samples[j].octave||4,m=a.samples[j].url,n=Polyhymnia.Notes.fromName(k,l);b(n,m)}}this.scheduleNote=function(a,b){var c=e.createBufferSource();c.buffer=f[a].buffer,c.playbackRate.value=f[a].pitch,c.connect(e.destination),c.start(b)},this.scheduleNotes=function(a,b){a.forEach(function(a){d.scheduleNote(a,b)})}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Sequencer=function(){"use strict";function a(a,b,e,f){var g=[];if(b==c.NOTE)g=[Polyhymnia.Notes.fromName(e)];else if(b==c.CHORD){var h,i,j=e.substr(1,1);"#"==j||"b"==j?(h=Polyhymnia.Notes.fromName(e.substr(0,2)),i=Polyhymnia.Chords.fromName(e.substr(2))):(h=Polyhymnia.Notes.fromName(e.substr(0,1)),i=Polyhymnia.Chords.fromName(e.substr(1))),g=i.map(function(a){return a+h})}else b==c.DRUM&&(g=[Polyhymnia.Notes.fromName("C")]);d.generator.instruments[a].scheduleNotes(g,f)}function b(a){for(var b=[1,2,4,8,16,32,64],c=d.stepsPerBeat,e=0;e<b.length&&!(a<d.measure.num*b[e]/4);e++)c=4*d.stepsPerBeat/b[e];return c}var c=Polyhymnia.noteType,d=this;this.measure={num:4,den:4},this.stepsPerBeat=16,this.generator=null,this.animCallback=void 0;var e=[],f=Polyhymnia.getAudioContext();this.scheduleStep=function(c,g){var h=c%(d.stepsPerBeat*d.measure.num);0===h&&(c>0&&d.generator.step(),e=d.generator.getPatterns());for(var i=[],j=0;j<e.length;j++){var k=e[j].instrument,l=e[j].pattern,m=b(l.length),n=Math.floor(h/m);if(n<l.length){var o=l[n];h%m===0&&a(k,o.type,o.value,g),i.push(o)}}var p=g-f.currentTime;i.length>0&&d.animCallback&&window.setTimeout(function(){d.animCallback(i)},p)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Synthesizer=function(a){"use strict";var b=this;a=a||{};var c=a.wave||"square",d=a.attack||.05,e=a.decay||.1,f=a.sustain||.8,g=a.release||.3,h=Polyhymnia.getAudioContext();this.scheduleNote=function(a,b){var i=h.createGain();i.connect(h.destination),i.gain.value=0;var j=h.createOscillator();j.type=c,j.frequency.value=Polyhymnia.Notes.toFrequency(a),j.connect(i),j.start(b),i.gain.linearRampToValueAtTime(0,b+1e-4),i.gain.linearRampToValueAtTime(1,b+d),i.gain.linearRampToValueAtTime(f,b+d+e),i.gain.linearRampToValueAtTime(0,b+d+e+g),j.stop(b+d+e+g+1e-4)},this.scheduleNotes=function(a,c){a.forEach(function(a){b.scheduleNote(a,c)})}};var Polyhymnia=Polyhymnia||{};Polyhymnia.getAudioContext=function(){"use strict";return Polyhymnia.audioContext||(window.AudioContext=window.AudioContext||window.webkitAudioContext,Polyhymnia.audioContext=new AudioContext),Polyhymnia.audioContext},Polyhymnia.isSupported=function(){"use strict";return window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext?!0:!1},Polyhymnia.Context=function(a){"use strict";function b(a){d.animCallback=a}if(!Polyhymnia.isSupported())return{play:function(){},stop:function(){},setParam:function(){},setRules:function(){},setAnimCallback:function(){}};var c=new Polyhymnia.Generator;c.setParam("x",0),c.instruments={};var d=new Polyhymnia.Sequencer;d.generator=c;var e=new Polyhymnia.Metronome;if(e.sequencer=d,a&&a.tempo&&(e.tempo=a.tempo),a&&a.instruments)for(var f=0;f<a.instruments.length;f++){var g=a.instruments[f];c.instruments[g.name]=new Polyhymnia.Sampler({samples:g.samples})}return{play:e.play,stop:e.stop,setParam:c.setParam,setRules:c.setRules,setAnimCallback:b}};