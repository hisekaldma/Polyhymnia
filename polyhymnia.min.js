var Polyhymnia=Polyhymnia||{};Polyhymnia.templates={player:'<div class="polyhymnia-player">    <div class="code">     <div class="display">       <div class="text"></div>       <div class="cursor-layer">         <div class="cursor blink">&nbsp;</div>       </div>     </div>     <textarea class="editor"></textarea>   </div>    <div class="controls">      <button class="play">       <svg x="0px" y="0px" width="18px" height="18px">         <path fill="none" stroke="#FF884D" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M16,9L2,17V1L16,9z"/>       </svg>     </button>      <button class="stop" style="display: none">       <svg x="0px" y="0px" width="18px" height="18px">         <rect x="2" y="2" fill="none" stroke="#FF884D" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" width="14" height="14"/>       </svg>     </button>      <div class="slider">       <div class="output hide">x = 0</div>       <input type="range" min="0" max="10" value="0" step="0.1" />     </div>      <div class="tempo">       <input type="number" min="1" max="320" value="120" step="1" maxlength="3" /><label>bpm</label>     </div>   </div>    <div class="not-supported" style="display: none">     Your browser doesn’t support web audio. Why don’t you try <a href="https://www.google.com/chrome/browser/desktop/">Chrome</a>?   </div> </div>'};var Polyhymnia=Polyhymnia||{};Polyhymnia.Generator=function(){"use strict";function a(b){var c={name:name||"",definitions:[]};return b?(b.definitions.forEach(function(b){if(b.sequence){for(var d=[],e=0;e<b.sequence.length;e++){var f=i[b.sequence[e]];d.push(a(f))}c.definitions.push({condition:b.condition,sequence:d,index:0})}else b.pattern&&c.definitions.push({condition:b.condition,pattern:b.pattern,instrument:b.instrument})}),c):c}function b(a){var c=!0;return a.definitions.forEach(function(a){if(a.sequence){var d=a.sequence[a.index],e=b(d);e&&a.index++,a.index>=a.sequence.length?a.index=0:c=!1}else a.pattern}),c}function c(a){var b=e(a.definitions),d=[];return b.forEach(function(a){if(a.sequence){var b=c(a.sequence[a.index]);b.forEach(function(a){d.push(a)})}else a.pattern&&d.push({instrument:a.instrument,pattern:a.pattern})}),d}function d(a,b){for(var c=0;c<a.definitions.length;c++){var e=a.definitions[c],f=b.definitions.length>c?b.definitions[c]:void 0;if(e&&f&&e.sequence&&f.sequence){f.index=e.index;var g=e.sequence[e.index],h=f.sequence[f.index];d(g,h)}}}function e(a){var b=[];return a.forEach(function(a){var c=a.condition;if(c){var d=f.getParam(c.param),e=void 0!==c.min?c.min:-1/0,g=void 0!==c.max?c.max:1/0;d>=e&&g>d&&b.push(a)}else b.push(a)}),b}var f=this,g="Play",h={},i=null,j=null;this.setParam=function(a,b){h[a]=b},this.getParam=function(a){return h[a]||0},this.getPatterns=function(){return c(j)},this.step=function(){b(j)},this.setRules=function(b){i={};for(var c=0;c<b.length;c++)i[b[c].name]=b[c];var e=j;j=a(i[g]),e&&d(e,j)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.noteType={PAUSE:"pause",NOTE:"note",CHORD:"chord",DRUM:"drum"},Polyhymnia.parse=function(a,b){"use strict";function c(a,b,c){u.push({error:a,start:b||m.start,end:c||m.end}),t.push({type:"error",error:a,start:b||m.start,end:c||m.end})}function d(){q=r.length>0,m=r.length>0?r.shift():{},n=r.length>0?r[0]:{}}function e(){for(;m&&m.type==o.EOL;)d()}function f(){return q?m.type==o.EOL?!0:m.type==o.NAME&&n&&n.type==o.SINGLE_ARROW?!0:!1:!0}function g(){var a="",b=[];for(m.type==o.NAME?a=m.value:c("Rules must start with a name"),d(),m.type!==o.SINGLE_ARROW&&c("Expected ->"),d(),m.type==o.EOL&&d();!f();)b.push(h()),d();return{name:a,definitions:b}}function h(){var a;if(m.type==o.LEFT_PAREN&&(a=l()),m.type==o.INSTRUMENT){var b=j();return{condition:a,instrument:b.instrument,pattern:b.pattern}}if(m.type==o.NAME){var d=i();return{condition:a,sequence:d}}return c("Expected a sequence or pattern"),{}}function i(){for(var a=[];m.type!==o.EOL&&q;)m.type==o.NAME?a.push(m.value):(c("Expected a rule name"),a.push("")),d();return a}function j(){var a=m.value;b&&!b[a]&&c("There is no instrument "+a),d();for(var e=[];m.type!==o.EOL&&q;)e.push(k());return{instrument:a,pattern:e}}function k(){var a,b="",e=m.start,f=m.end,g=!0;return m.type==o.NOTE?(a=p.NOTE,b=m.value):m.type==o.CHORD?(a=p.CHORD,b=m.value):m.type==o.DRUM_TRIGGER?(a=p.DRUM,b=m.value):m.type==o.PAUSE?a=p.PAUSE:(c("Expected a note, chord, drum symbol or pause"),g=!1,a=p.PAUSE),g&&t.push({type:"note",start:e,end:f}),d(),{type:a,value:b,start:e,end:f}}function l(){for(var a=m.start,b=m.end,e=[];q&&m.type!==o.EOL;){if(e.push(m),b=m.end,m.type==o.RIGHT_PAREN){d();break}d()}var f,g,h;if(5==e.length&&e[0].type==o.LEFT_PAREN&&e[1].type==o.NUMBER&&e[2].type==o.GREATER_THAN&&e[3].type==o.PARAM&&e[4].type==o.RIGHT_PAREN)g=e[1].value,h=e[3].value;else if(5==e.length&&e[0].type==o.LEFT_PAREN&&e[1].type==o.NUMBER&&e[2].type==o.LESS_THAN&&e[3].type==o.PARAM&&e[4].type==o.RIGHT_PAREN)f=e[1].value,h=e[3].value;else if(5==e.length&&e[0].type==o.LEFT_PAREN&&e[1].type==o.PARAM&&e[2].type==o.GREATER_THAN&&e[3].type==o.NUMBER&&e[4].type==o.RIGHT_PAREN)h=e[1].value,f=e[3].value;else if(5==e.length&&e[0].type==o.LEFT_PAREN&&e[1].type==o.PARAM&&e[2].type==o.LESS_THAN&&e[3].type==o.NUMBER&&e[4].type==o.RIGHT_PAREN)h=e[1].value,g=e[3].value;else if(7==e.length&&e[0].type==o.LEFT_PAREN&&e[1].type==o.NUMBER&&e[2].type==o.LESS_THAN&&e[3].type==o.PARAM&&e[4].type==o.LESS_THAN&&e[5].type==o.NUMBER&&e[6].type==o.RIGHT_PAREN)f=e[1].value,h=e[3].value,g=e[5].value;else{if(7!=e.length||e[0].type!=o.LEFT_PAREN||e[1].type!=o.NUMBER||e[2].type!=o.GREATER_THAN||e[3].type!=o.PARAM||e[4].type!=o.GREATER_THAN||e[5].type!=o.NUMBER||e[6].type!=o.RIGHT_PAREN)return void c("Expected a condition",a,b);g=e[1].value,h=e[3].value,f=e[5].value}return{param:h,min:f,max:g}}var m,n,o=Polyhymnia.tokenType,p=Polyhymnia.noteType,q=!0,r=a.slice(0),s=[],t=[],u=[];for(d(),e();q;)s.push(g()),e();return s.forEach(function(a){a.definitions.forEach(function(a){a.sequence&&a.sequence.forEach(function(a){for(var b=!1,c=0;c<s.length;c++)s[c].name==a&&(b=!0);b||u.push({error:"There is no rule "+a})})})}),s.symbols=t,s.errors=u,s};var Polyhymnia=Polyhymnia||{};Polyhymnia.tokenType={NAME:"name",NUMBER:"number",INSTRUMENT:"instrument",PAUSE:"pause",NOTE:"note",CHORD:"chord",DRUM_TRIGGER:"drum trigger",SINGLE_ARROW:"single arrow",DOUBLE_ARROW:"double arrow",LEFT_PAREN:"left paren",RIGHT_PAREN:"right paren",PARAM:"param",LESS_THAN:"less than",GREATER_THAN:"greater than",COMMENT:"comment",ERROR:"error",EOL:"eol"},Polyhymnia.tokenize=function(a){"use strict";function b(){F++,d=F<B.length,d&&(e=B[F],E++)}function c(){for(var a="";d&&-1===q.indexOf(e);)a+=e,b();return a}var d,e,f=Polyhymnia.tokenType,g="[A-Z][a-zA-Z0-9_]+",h="[a-z][a-zA-Z0-9_]*",i=g+":",j="-?(([1-9][0-9]*)|0)(\\.[0-9]*)?",k="[CDEFGAB][#b]?",l=k+"(M|m|dom|aug|dim)7?",m="[xX]",n="\n",o=" ",p="	",q="()\n	 ",r="sequence",s="condition",t=new RegExp("^"+g+"$"),u=new RegExp("^"+h+"$"),v=new RegExp("^"+i+"$"),w=new RegExp("^"+j+"$"),x=new RegExp("^"+k+"$"),y=new RegExp("^"+l+"$"),z=new RegExp("^"+m+"$"),A=a.replace("\r",""),B=A.split(""),C=[],D=1,E=-1,F=-1;b();for(var G,H,I,J,K=r;d;)J=void 0,G=void 0,H=D,I=E,e==n?(D++,G={type:f.EOL},K=r,b()):e==o||e==p?b():"("==e?(G={type:f.LEFT_PAREN},K=s,b()):")"==e?(G={type:f.RIGHT_PAREN},K=r,b()):(J=c(),G=K==s&&J.match(u)?{type:f.PARAM,value:J}:"->"==J?{type:f.SINGLE_ARROW}:"=>"==J?{type:f.DOUBLE_ARROW}:">"==J?{type:f.GREATER_THAN}:"<"==J?{type:f.LESS_THAN}:"_"==J?{type:f.PAUSE}:J.match(z)?{type:f.DRUM_TRIGGER,value:J}:J.match(x)?{type:f.NOTE,value:J}:J.match(y)?{type:f.CHORD,value:J}:J.match(v)?{type:f.INSTRUMENT,value:J.substr(0,J.length-1)}:J.match(w)?{type:f.NUMBER,value:J}:J.match(t)?{type:f.NAME,value:J}:J.match(u)?{type:f.PARAM,value:J}:{type:f.ERROR,value:J}),void 0!==G&&(G.line=H,G.start=I,G.end=J?I+J.length:I+1,C.push(G));return C};var Polyhymnia=Polyhymnia||{};Polyhymnia.Chords=function(){"use strict";var a={};return a.chords={M:[0,4,7],m:[0,3,7],M7:[0,4,7,11],m7:[0,3,7,10],dom7:[0,4,7,10],aug:[0,4,8],aug7:[0,4,8,10],dim:[0,3,6],dim7:[0,3,6,9]},a.toName=function(b){b.forEach(function(a,c){b[c]=a%12});for(var c in a.chords){var d=a.chords[c];if(d.length==b.length){for(var e=!0,f=0;f<d.length;f++)d[f]!=b[f]&&(e=!1);if(e)return c}}return""},a.fromName=function(b){return b in a.chords?a.chords[b]:[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Notes=function(){"use strict";var a={};return a.notes={C:0,"B#":0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11},a.notesReverse={0:"C",1:"C#",2:"D",3:"D#",4:"E",5:"F",6:"F#",7:"G",8:"G#",9:"A",10:"A#",11:"B"},a.toName=function(b){return a.notesReverse[b%12]},a.fromName=function(b,c){return c?c+=2:c=5,b in a.notes?a.notes[b]+12*c:0},a.toFrequency=function(a){return 440*Math.pow(2,(a-69)/12)},a.fromFrequency=function(a){return Math.round(69+12*Math.log(.0022727272727*a)/Math.LN2)},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Scales=function(){"use strict";var a={};return a.scales={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],"pentatonic-major":[0,2,4,7,9],"pentatonic-minor":[0,3,5,7,10]},a.toName=function(b){b.forEach(function(a,c){b[c]=a%12});for(var c in a.scales){var d=a.scales[c];if(d.length==b.length){for(var e=!0,f=0;f<d.length;f++)d[f]!=b[f]&&(e=!1);if(e)return c}}return""},a.fromName=function(b){return b in a.scales?a.scales[b]:[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Player=function(a,b){"use strict";function c(){e(),l.play(),o.style.display="none",p.style.display="block"}function d(){l.stop(),o.style.display="block",p.style.display="none",j([])}function e(){var a=l.parse(t.value);m=a.symbols,h()}function f(){""===s.value?s.value=120:s.value>parseInt(s.max)?s.value=s.max:s.value<parseInt(s.min)&&(s.value=s.min),l.setTempo(s.value)}function g(){l.setParam("x",q.valueAsNumber),r.textContent="x = "+q.value,r.classList.remove("hide"),r.classList.add("show");var a=q.value/(q.max-q.min),b=8*(1-a)-8*a;r.style.left=a*q.offsetWidth-r.offsetWidth/2+b+"px",setTimeout(function(){r.classList.add("hide"),r.classList.remove("show")},2e3)}function h(){for(var a=t.value,b="",c=0,d=0;d<a.length;d++)c<m.length&&m[c].start==d&&(b+='<span class="'+m[c].type+'" data-start="'+m[c].start+'">'),b+=a.charAt(d),c<m.length&&m[c].end==d+1&&(b+="</span>",c++);v.innerHTML=b,y=[];for(var e=v.querySelectorAll(".note"),f=0;f<e.length;f++)y.push({elem:e[f],start:e[f].dataset.start})}function i(){var a="forward"==t.selectionDirection?t.selectionEnd:t.selectionStart;if(document.activeElement===t){if(w.style.display="block",a!==z){z=a;var b=w.getBoundingClientRect(),c=b.height-(w.offsetHeight-w.clientHeight),d=b.width-(w.offsetWidth-w.clientWidth),e=t.value.substr(0,z).split("\n"),f=(e.length-1)*c,g=e[e.length-1].length*d;w.classList.remove("blink"),w.style.top=f+"px",w.style.left=g-1+"px";{w.offsetWidth}w.classList.add("blink")}}else w.style.display="none";u.scrollTop=t.scrollTop,window.requestAnimationFrame(i)}function j(a){for(var b=0;b<y.length;b++){for(var c=!1,d=0;d<a.length;d++)y[b].start==a[d].start&&(c=!0);y[b].elem.className=c?"playing":"note"}}var k=a.textContent,l=b,m=[];l.setAnimCallback(j),a.innerHTML=Polyhymnia.templates.player;var n=a.querySelector(".controls"),o=a.querySelector(".play"),p=a.querySelector(".stop"),q=a.querySelector(".slider input"),r=a.querySelector(".slider .output"),s=a.querySelector(".tempo input"),t=a.querySelector(".code .editor"),u=a.querySelector(".code .display"),v=a.querySelector(".code .text"),w=a.querySelector(".code .cursor"),x=a.querySelector(".not-supported"),y=[];t.value=k;var z;Polyhymnia.isSupported()?(o.addEventListener("click",c),p.addEventListener("click",d),q.addEventListener("input",g),s.addEventListener("input",f),t.addEventListener("input",e)):(n.style.display="none",x.style.display="block"),h(),window.requestAnimationFrame(i)};var Polyhymnia=Polyhymnia||{};Polyhymnia.Metronome=function(){"use strict";function a(){if(!document.hidden)for(;f<h.currentTime+c.lookahead;)c.sequencer.scheduleStep(e,f),b();g=window.setTimeout(a,c.interval)}function b(){var a=60/c.tempo;f+=a/c.stepsPerBeat,e++}var c=this;this.tempo=120,this.stepsPerBeat=16,this.interval=25,this.lookahead=.1,this.sequencer=null;var d=!1,e=0,f=0,g=0,h=Polyhymnia.getAudioContext();this.play=function(){d||(e=0,f=h.currentTime,a(),d=!0)},this.stop=function(){d&&(window.clearTimeout(g),d=!1)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Sampler=function(a){"use strict";function b(a,b){function d(){h++,h>=i&&c()}var f=new XMLHttpRequest;f.open("GET",b,!0),f.responseType="arraybuffer",f.onload=function(){e.decodeAudioData(f.response,function(c){console.log("Loaded "+b),g[a]=c,d()},function(){console.log("Error decoding audio file: "+b),d()})},f.send()}function c(){for(var a=0;128>a;a++)if(void 0!==g[a])f[a]={buffer:g[a],pitch:1};else{for(var b,c,d=0;a>d;d++)g[d]&&(b=d);for(var e=127;e>a;e--)g[e]&&(c=e);var h;if(c&&b?h=a-b>c-a?c:b:c?h=c:b&&(h=b),h){var i=Polyhymnia.Notes.toFrequency(a),j=Polyhymnia.Notes.toFrequency(h),k=i/j;f[a]={buffer:g[h],pitch:k,orig:h}}}}var d=this,e=Polyhymnia.getAudioContext(),f=[],g=[],h=0,i=0;if(a&&a.samples){i=a.samples.length;for(var j=0;j<a.samples.length;j++){var k=a.samples[j].root||"C",l=a.samples[j].octave||4,m=a.samples[j].url,n=Polyhymnia.Notes.fromName(k,l);b(n,m)}}this.scheduleNote=function(a,b){var c=e.createBufferSource();c.buffer=f[a].buffer,c.playbackRate.value=f[a].pitch,c.connect(e.destination),c.start(b)},this.scheduleNotes=function(a,b){a.forEach(function(a){d.scheduleNote(a,b)})}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Sequencer=function(){"use strict";function a(a,b,e,f){var g=[];if(b==c.NOTE)g=[Polyhymnia.Notes.fromName(e)];else if(b==c.CHORD){var h,i,j=e.substr(1,1);"#"==j||"b"==j?(h=Polyhymnia.Notes.fromName(e.substr(0,2)),i=Polyhymnia.Chords.fromName(e.substr(2))):(h=Polyhymnia.Notes.fromName(e.substr(0,1)),i=Polyhymnia.Chords.fromName(e.substr(1))),g=i.map(function(a){return a+h})}else b==c.DRUM&&(g=[Polyhymnia.Notes.fromName("C")]);d.instruments[a]&&d.instruments[a].scheduleNotes(g,f)}function b(a){for(var b=[1,2,4,8,16,32,64],c=d.stepsPerBeat,e=0;e<b.length&&!(a<d.measure.num*b[e]/4);e++)c=4*d.stepsPerBeat/b[e];return c}var c=Polyhymnia.noteType,d=this;this.instruments={},this.measure={num:4,den:4},this.stepsPerBeat=16,this.generator=null,this.animCallback=void 0;var e=[],f=Polyhymnia.getAudioContext();this.scheduleStep=function(c,g){var h=c%(d.stepsPerBeat*d.measure.num);0===h&&(c>0&&d.generator.step(),e=d.generator.getPatterns());for(var i=[],j=0;j<e.length;j++){var k=e[j].instrument,l=e[j].pattern,m=b(l.length),n=Math.floor(h/m);if(n<l.length){var o=l[n];h%m===0&&a(k,o.type,o.value,g),i.push(o)}}var p=g-f.currentTime;i.length>0&&d.animCallback&&window.setTimeout(function(){d.animCallback(i)},p)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Synthesizer=function(a){"use strict";var b=this;a=a||{};var c=a.wave||"square",d=a.attack||.05,e=a.decay||.1,f=a.sustain||.8,g=a.release||.3,h=Polyhymnia.getAudioContext();this.scheduleNote=function(a,b){var i=h.createGain();i.connect(h.destination),i.gain.value=0;var j=h.createOscillator();j.type=c,j.frequency.value=Polyhymnia.Notes.toFrequency(a),j.connect(i),j.start(b),i.gain.linearRampToValueAtTime(0,b+1e-4),i.gain.linearRampToValueAtTime(1,b+d),i.gain.linearRampToValueAtTime(f,b+d+e),i.gain.linearRampToValueAtTime(0,b+d+e+g),j.stop(b+d+e+g+1e-4)},this.scheduleNotes=function(a,c){a.forEach(function(a){b.scheduleNote(a,c)})}};var Polyhymnia=Polyhymnia||{};Polyhymnia.getAudioContext=function(){"use strict";return Polyhymnia.audioContext||(window.AudioContext=window.AudioContext||window.webkitAudioContext,Polyhymnia.audioContext=new AudioContext),Polyhymnia.audioContext},Polyhymnia.isSupported=function(){"use strict";return window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext?!0:!1},Polyhymnia.Context=function(a){"use strict";function b(a){var b=Polyhymnia.tokenize(a),c=Polyhymnia.parse(b,f.instruments);return e.setRules(c),c}function c(a){g.tempo=a}function d(a){f.animCallback=a}if(!Polyhymnia.isSupported())return{play:function(){},stop:function(){},setParam:function(){},setRules:function(){},setTempo:function(){},setAnimCallback:function(){}};var e=new Polyhymnia.Generator;e.setParam("x",0),e.instruments={};var f=new Polyhymnia.Sequencer;f.generator=e;var g=new Polyhymnia.Metronome;if(g.sequencer=f,a&&a.tempo&&(g.tempo=a.tempo),a&&a.instruments)for(var h=0;h<a.instruments.length;h++){var i=a.instruments[h];f.instruments[i.name]=new Polyhymnia.Sampler({samples:i.samples})}return{parse:b,play:g.play,stop:g.stop,setParam:e.setParam,setTempo:c,setAnimCallback:d}};