var Polyhymnia=Polyhymnia||{};Polyhymnia.templates={editor:'<div class="polyhymnia-editor">    <div class="code">     <div class="display">       <div class="text"></div>       <div class="cursor-layer">         <div class="cursor blink">&nbsp;</div>       </div>     </div>     <textarea class="editor" spellcheck="false"></textarea>   </div>    <div class="controls">      <button class="play">       <svg x="0px" y="0px" width="18px" height="18px">         <path fill="none" stroke="#FF884D" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M16,9L2,17V1L16,9z"/>       </svg>     </button>      <button class="stop" style="display: none">       <svg x="0px" y="0px" width="18px" height="18px">         <rect x="2" y="2" fill="none" stroke="#FF884D" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" width="14" height="14"/>       </svg>     </button>      <div class="slider">       <div class="output hide">x = 0</div>       <input type="range" min="0" max="10" value="0" step="0.1" />     </div>      <div class="settings">           <input class="tempo" type="number" min="1" max="320" value="120" step="1" maxlength="3" /><label>bpm</label>       <select class="time">         <option>3/4</option>         <option selected>4/4</option>         <option>5/4</option>         <option>6/8</option>         <option>7/8</option>       </select>     </div>   </div>    <div class="not-supported" style="display: none">     Your browser doesn’t support web audio. Why don’t you try <a href="https://www.google.com/chrome/browser/desktop/">Chrome</a>?   </div> </div>'};var Polyhymnia=Polyhymnia||{};Polyhymnia.Editor=function(a,b){"use strict";function c(){e(),m.play(),p.style.display="none",q.style.display="block",C=!0}function d(){m.stop(),p.style.display="block",q.style.display="none",C=!1,k([])}function e(){var a=m.parse(v.value);n=a.symbols,i()}function f(){var a=u.value.split("/"),b=parseInt(a[0]),c=parseInt(a[1]);m.setTimeSignature(b,c)}function g(){""===t.value?t.value=120:t.value>parseInt(t.max)?t.value=t.max:t.value<parseInt(t.min)&&(t.value=t.min),m.setTempo(t.value)}function h(){m.setParam("x",r.valueAsNumber),s.textContent="x = "+r.value,s.classList.remove("hide"),s.classList.add("show");var a=r.value/(r.max-r.min),b=8*(1-a)-8*a;s.style.left=a*r.offsetWidth-s.offsetWidth/2+b+"px",setTimeout(function(){s.classList.add("hide"),s.classList.remove("show")},2e3)}function i(){for(var a=v.value,b="",c=0,d=0;d<a.length;d++)c<n.length&&n[c].start==d&&(b+='<span class="'+n[c].type+'" data-start="'+n[c].start+'">'),b+=a.charAt(d),c<n.length&&n[c].end==d+1&&(b+="</span>",c++);x.innerHTML=b,A=[];for(var e=x.querySelectorAll(".note"),f=0;f<e.length;f++)A.push({elem:e[f],start:e[f].dataset.start})}function j(){var a="forward"==v.selectionDirection?v.selectionEnd:v.selectionStart;if(document.activeElement===v){if(y.style.display="block",a!==B){B=a;var b=y.getBoundingClientRect(),c=b.height-(y.offsetHeight-y.clientHeight),d=b.width-(y.offsetWidth-y.clientWidth),e=v.value.substr(0,B).split("\n"),f=(e.length-1)*c,g=e[e.length-1].length*d;y.classList.remove("blink"),y.style.top=f+"px",y.style.left=g-1+"px";{y.offsetWidth}y.classList.add("blink")}}else y.style.display="none";w.scrollTop=v.scrollTop,window.requestAnimationFrame(j)}function k(a){for(var b=0;b<A.length;b++){for(var c=!1,d=0;d<a.length;d++)A[b].start==a[d].start&&(c=!0);A[b].elem.className=C&&c?"playing":"note"}}var l=a.textContent,m=b,n=[];m.setAnimCallback(k),a.innerHTML=Polyhymnia.templates.editor;var o=a.querySelector(".controls"),p=a.querySelector(".play"),q=a.querySelector(".stop"),r=a.querySelector(".slider input"),s=a.querySelector(".slider .output"),t=a.querySelector(".settings .tempo"),u=a.querySelector(".settings .time"),v=a.querySelector(".code .editor"),w=a.querySelector(".code .display"),x=a.querySelector(".code .text"),y=a.querySelector(".code .cursor"),z=a.querySelector(".not-supported"),A=[];v.value=l;var B,C=!1;Polyhymnia.isSupported()?(p.addEventListener("click",c),q.addEventListener("click",d),r.addEventListener("input",h),t.addEventListener("input",g),u.addEventListener("input",f),v.addEventListener("input",e)):(o.style.display="none",z.style.display="block"),e(),window.requestAnimationFrame(j)};var Polyhymnia=Polyhymnia||{};Polyhymnia.Generator=function(){"use strict";function a(b){var c={name:name||"",definitions:[]};return b?(b.definitions.forEach(function(b){if(b.sequence){for(var d=[],e=0;e<b.sequence.length;e++){var f=i[b.sequence[e]];d.push(a(f))}c.definitions.push({condition:b.condition,sequence:d,index:0})}else b.pattern&&c.definitions.push({condition:b.condition,pattern:b.pattern,instrument:b.instrument})}),c):c}function b(a){var c=!0;return a.definitions.forEach(function(a){if(a.sequence){var d=a.sequence[a.index],e=b(d);e&&a.index++,a.index>=a.sequence.length?a.index=0:c=!1}else a.pattern}),c}function c(a){var b=e(a.definitions),d=[];return b.forEach(function(a){if(a.sequence){var b=c(a.sequence[a.index]);b.forEach(function(a){d.push(a)})}else a.pattern&&d.push({instrument:a.instrument,pattern:a.pattern})}),d}function d(a,b){for(var c=0;c<a.definitions.length;c++){var e=a.definitions[c],f=b.definitions.length>c?b.definitions[c]:void 0;if(e&&f&&e.sequence&&f.sequence){f.index=e.index;var g=e.sequence[e.index],h=f.sequence[f.index];d(g,h)}}}function e(a){var b=[];return a.forEach(function(a){var c=a.condition;if(c){var d=f.getParam(c.param),e=void 0!==c.min?c.min:-1/0,g=void 0!==c.max?c.max:1/0;d>=e&&g>d&&b.push(a)}else b.push(a)}),b}var f=this,g="Play",h={},i=null,j=null;this.setParam=function(a,b){h[a]=b},this.getParam=function(a){return h[a]||0},this.getPatterns=function(){return c(j)},this.step=function(){b(j)},this.setRules=function(b){i={};for(var c=0;c<b.length;c++)i[b[c].name]=b[c];var e=j;j=a(i[g]),e&&d(e,j)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.noteType={PAUSE:"pause",NOTE:"note",CHORD:"chord",DRUM:"drum"},Polyhymnia.symbolType={NAME:"name",ARROW:"arrow",REFERENCE:"reference",INSTRUMENT:"instrument",NOTE:"note",CONDITION:"condition"},Polyhymnia.parse=function(a,b){"use strict";function c(a,b,c){v.push({type:a,start:b||n.start,end:c||n.end})}function d(a,b,c){w.push({error:a,start:b||n.start,end:c||n.end}),v.push({type:"error",error:a,start:b||n.start,end:c||n.end})}function e(){s=t.length>0,n=t.length>0?t.shift():{},o=t.length>0?t[0]:{}}function f(){for(;n&&n.type==p.EOL;)e()}function g(){return s?n.type==p.EOL?!0:n.type==p.NAME&&o&&o.type==p.ARROW?!0:!1:!0}function h(){var a="",b=[];for(n.type==p.NAME?(a=n.value,c(r.NAME)):d("Rules must start with a name"),e(),n.type==p.ARROW?c(r.ARROW):d("Expected ->"),e(),n.type==p.EOL&&e();!g();)b.push(i()),e();return{name:a,definitions:b}}function i(){var a;if(n.type==p.LEFT_PAREN&&(a=m()),n.type==p.INSTRUMENT){var b=k();return{condition:a,instrument:b.instrument,pattern:b.pattern}}if(n.type==p.NAME){var c=j();return{condition:a,sequence:c}}return d("Expected a sequence or pattern"),{}}function j(){for(var a=[];n.type!==p.EOL&&s;)n.type==p.NAME?(a.push(n.value),c(r.REFERENCE)):(d("Expected a rule name"),a.push("")),e();return a}function k(){var a=n.value;b&&!b[a]?d("There is no instrument "+a):c(r.INSTRUMENT),e();for(var f=[];n.type!==p.EOL&&s;)f.push(l());return{instrument:a,pattern:f}}function l(){var a,b="",f=n.start,g=n.end,h=!0;return n.type==p.NOTE?(a=q.NOTE,b=n.value):n.type==p.CHORD?(a=q.CHORD,b=n.value):n.type==p.DRUM_TRIGGER?(a=q.DRUM,b=n.value):n.type==p.PAUSE?a=q.PAUSE:(d("Expected a note, chord, drum symbol or pause"),h=!1,a=q.PAUSE),h&&c(r.NOTE),e(),{type:a,value:b,start:f,end:g}}function m(){for(var a=n.start,b=n.end,f=[];s&&n.type!==p.EOL;){if(f.push(n),b=n.end,n.type==p.RIGHT_PAREN){e();break}e()}var g,h,i;if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.NUMBER&&f[2].type==p.GREATER_THAN&&f[3].type==p.PARAM&&f[4].type==p.RIGHT_PAREN)h=f[1].value,i=f[3].value;else if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.NUMBER&&f[2].type==p.LESS_THAN&&f[3].type==p.PARAM&&f[4].type==p.RIGHT_PAREN)g=f[1].value,i=f[3].value;else if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.PARAM&&f[2].type==p.GREATER_THAN&&f[3].type==p.NUMBER&&f[4].type==p.RIGHT_PAREN)i=f[1].value,g=f[3].value;else if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.PARAM&&f[2].type==p.LESS_THAN&&f[3].type==p.NUMBER&&f[4].type==p.RIGHT_PAREN)i=f[1].value,h=f[3].value;else if(7==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.NUMBER&&f[2].type==p.LESS_THAN&&f[3].type==p.PARAM&&f[4].type==p.LESS_THAN&&f[5].type==p.NUMBER&&f[6].type==p.RIGHT_PAREN)g=f[1].value,i=f[3].value,h=f[5].value;else{if(7!=f.length||f[0].type!=p.LEFT_PAREN||f[1].type!=p.NUMBER||f[2].type!=p.GREATER_THAN||f[3].type!=p.PARAM||f[4].type!=p.GREATER_THAN||f[5].type!=p.NUMBER||f[6].type!=p.RIGHT_PAREN)return void d("Expected a condition",a,b);h=f[1].value,i=f[3].value,g=f[5].value}return c(r.CONDITION,a,b),{param:i,min:g,max:h}}var n,o,p=Polyhymnia.tokenType,q=Polyhymnia.noteType,r=Polyhymnia.symbolType,s=!0,t=a.slice(0),u=[],v=[],w=[];for(e(),f();s;)u.push(h()),f();return u.forEach(function(a){a.definitions.forEach(function(a){a.sequence&&a.sequence.forEach(function(a){for(var b=!1,c=0;c<u.length;c++)u[c].name==a&&(b=!0);b||w.push({error:"There is no rule "+a})})})}),u.symbols=v,u.errors=w,u};var Polyhymnia=Polyhymnia||{};Polyhymnia.tokenType={NAME:"name",NUMBER:"number",INSTRUMENT:"instrument",PAUSE:"pause",NOTE:"note",CHORD:"chord",DRUM_TRIGGER:"drum trigger",ARROW:"arrow",LEFT_PAREN:"left paren",RIGHT_PAREN:"right paren",PARAM:"param",LESS_THAN:"less than",GREATER_THAN:"greater than",COMMENT:"comment",ERROR:"error",EOL:"eol"},Polyhymnia.tokenize=function(a){"use strict";function b(){H++,d=H<D.length,d&&(e=D[H],G++)}function c(){for(var a="";d&&-1===r.indexOf(e);)a+=e,b();return a}var d,e,f=Polyhymnia.tokenType,g="[A-Z][a-zA-Z0-9_]*",h="[a-z][a-zA-Z0-9_]*",i=g+":",j="-?(([1-9][0-9]*)|0)(\\.[0-9]*)?",k="([CDEFGAB][#b]?)",l="(-2|-1|[0-8])?",m="((M|m|dom|aug|dim)7?)",n="[xX]",o="\n",p=" ",q="	",r="()\n	 ",s="sequence",t="pattern",u="condition",v=new RegExp("^"+g+"$"),w=new RegExp("^"+h+"$"),x=new RegExp("^"+i+"$"),y=new RegExp("^"+j+"$"),z=new RegExp("^"+k+l+"$"),A=new RegExp("^"+k+l+m+"$"),B=new RegExp("^"+n+"$"),C=a.replace("\r",""),D=C.split(""),E=[],F=1,G=-1,H=-1;b();for(var I,J,K,L,M,N,O=s;d;)L=void 0,I=void 0,J=F,K=G,e==o?(F++,I={type:f.EOL},O=s,b()):e==p||e==q?b():"("==e?(I={type:f.LEFT_PAREN},O=u,b()):")"==e?(I={type:f.RIGHT_PAREN},O=s,b()):(L=c(),O==u?I=">"==L?{type:f.GREATER_THAN}:"<"==L?{type:f.LESS_THAN}:L.match(w)?{type:f.PARAM,value:L}:L.match(y)?{type:f.NUMBER,value:parseFloat(L)}:{type:f.ERROR,value:L}:O==t?"_"==L?I={type:f.PAUSE}:L.match(B)?I={type:f.DRUM_TRIGGER,value:L}:L.match(z)?(M=L.match(z),N=M[2]?parseInt(M[2]):void 0,I={type:f.NOTE,value:{note:M[1],octave:N}}):L.match(A)?(M=L.match(A),N=M[2]?parseInt(M[2]):void 0,I={type:f.CHORD,value:{note:M[1],octave:N,chord:M[3]}}):I={type:f.ERROR,value:L}:"->"==L?I={type:f.ARROW}:L.match(v)?I={type:f.NAME,value:L}:L.match(x)?(I={type:f.INSTRUMENT,value:L.substr(0,L.length-1)},O=t):I={type:f.ERROR,value:L}),void 0!==I&&(I.line=J,I.start=K,I.end=L?K+L.length:K+1,E.push(I));return E};var Polyhymnia=Polyhymnia||{};Polyhymnia.Chords=function(){"use strict";var a={};return a.chords={M:[0,4,7],m:[0,3,7],M7:[0,4,7,11],m7:[0,3,7,10],dom7:[0,4,7,10],aug:[0,4,8],aug7:[0,4,8,10],dim:[0,3,6],dim7:[0,3,6,9]},a.toName=function(b){b.forEach(function(a,c){b[c]=a%12});for(var c in a.chords){var d=a.chords[c];if(d.length==b.length){for(var e=!0,f=0;f<d.length;f++)d[f]!=b[f]&&(e=!1);if(e)return c}}return""},a.fromName=function(b){return b in a.chords?a.chords[b]:[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Notes=function(){"use strict";var a={};return a.notes={C:0,"B#":0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11},a.notesReverse={0:"C",1:"C#",2:"D",3:"D#",4:"E",5:"F",6:"F#",7:"G",8:"G#",9:"A",10:"A#",11:"B"},a.toName=function(b){return a.notesReverse[b%12]},a.fromName=function(b,c){return c?c+=2:c=5,b in a.notes?a.notes[b]+12*c:0},a.toFrequency=function(a){return 440*Math.pow(2,(a-69)/12)},a.fromFrequency=function(a){return Math.round(69+12*Math.log(.0022727272727*a)/Math.LN2)},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Scales=function(){"use strict";var a={};return a.scales={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],"pentatonic-major":[0,2,4,7,9],"pentatonic-minor":[0,3,5,7,10]},a.toName=function(b){b.forEach(function(a,c){b[c]=a%12});for(var c in a.scales){var d=a.scales[c];if(d.length==b.length){for(var e=!0,f=0;f<d.length;f++)d[f]!=b[f]&&(e=!1);if(e)return c}}return""},a.fromName=function(b){return b in a.scales?a.scales[b]:[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Metronome=function(){"use strict";function a(){if(!document.hidden)for(;f<h.currentTime+c.lookahead;)c.sequencer.scheduleStep(e,f),b();g=window.setTimeout(a,c.interval)}function b(){var a=60/c.tempo;f+=a/c.stepsPerBeat,e++}var c=this;this.tempo=120,this.stepsPerBeat=16,this.interval=25,this.lookahead=.1,this.sequencer=null;var d=!1,e=0,f=0,g=0,h=Polyhymnia.getAudioContext();this.play=function(){d||(e=0,f=h.currentTime,a(),d=!0)},this.stop=function(){d&&(window.clearTimeout(g),d=!1)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Sampler=function(a){"use strict";function b(a,b){function d(){h++,h>=i&&c()}var f=new XMLHttpRequest;f.open("GET",b,!0),f.responseType="arraybuffer",f.onload=function(){e.decodeAudioData(f.response,function(c){console.log("Loaded "+b),g[a]=c,d()},function(){console.log("Error decoding audio file: "+b),d()})},f.send()}function c(){for(var a=0;128>a;a++)if(void 0!==g[a])f[a]={buffer:g[a],pitch:1};else{for(var b,c,d=0;a>d;d++)g[d]&&(b=d);for(var e=127;e>a;e--)g[e]&&(c=e);var h;if(c&&b?h=a-b>c-a?c:b:c?h=c:b&&(h=b),h){var i=Polyhymnia.Notes.toFrequency(a),j=Polyhymnia.Notes.toFrequency(h),k=i/j;f[a]={buffer:g[h],pitch:k,orig:h}}}}var d=this,e=Polyhymnia.getAudioContext(),f=[],g=[],h=0,i=0;if(a&&a.samples){i=a.samples.length;for(var j=0;j<a.samples.length;j++){var k=a.samples[j].root||"C",l=a.samples[j].octave||4,m=a.samples[j].url,n=Polyhymnia.Notes.fromName(k,l);b(n,m)}}this.scheduleNote=function(a,b){var c=e.createBufferSource();c.buffer=f[a].buffer,c.playbackRate.value=f[a].pitch,c.connect(e.destination),c.start(b)},this.scheduleNotes=function(a,b){a.forEach(function(a){d.scheduleNote(a,b)})}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Sequencer=function(){"use strict";function a(a,b,e,f){var g=[];if(b==c.NOTE)g=[Polyhymnia.Notes.fromName(e.note,e.octave)];else if(b==c.CHORD){var h=Polyhymnia.Notes.fromName(e.note,e.octave),i=Polyhymnia.Chords.fromName(e.chord);g=i.map(function(a){return a+h})}else b==c.DRUM&&(g=[Polyhymnia.Notes.fromName("C")]);d.instruments[a]&&d.instruments[a].scheduleNotes(g,f)}function b(a){for(var b=[1,2,4,8,16,32,64],c=d.stepsPerBeat,e=0;e<b.length&&!(a<d.timeSignature.num*b[e]/4);e++)c=4*d.stepsPerBeat/b[e];return c}var c=Polyhymnia.noteType,d=this;this.instruments={},this.timeSignature={num:4,den:4},this.stepsPerBeat=16,this.generator=null,this.animCallback=void 0;var e=[],f=Polyhymnia.getAudioContext();this.scheduleStep=function(c,g){var h=c%(d.stepsPerBeat*d.timeSignature.num);0===h&&(c>0&&d.generator.step(),e=d.generator.getPatterns());for(var i=[],j=0;j<e.length;j++){var k=e[j].instrument,l=e[j].pattern,m=b(l.length),n=Math.floor(h/m);if(n<l.length){var o=l[n];h%m===0&&a(k,o.type,o.value,g),i.push(o)}}var p=g-f.currentTime;i.length>0&&d.animCallback&&window.setTimeout(function(){d.animCallback(i)},p)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Synthesizer=function(a){"use strict";var b=this;a=a||{};var c=a.wave||"square",d=a.attack||.05,e=a.decay||.1,f=a.sustain||.8,g=a.release||.3,h=Polyhymnia.getAudioContext();this.scheduleNote=function(a,b){var i=h.createGain();i.connect(h.destination),i.gain.value=0;var j=h.createOscillator();j.type=c,j.frequency.value=Polyhymnia.Notes.toFrequency(a),j.connect(i),j.start(b),i.gain.linearRampToValueAtTime(0,b+1e-4),i.gain.linearRampToValueAtTime(1,b+d),i.gain.linearRampToValueAtTime(f,b+d+e),i.gain.linearRampToValueAtTime(0,b+d+e+g),j.stop(b+d+e+g+1e-4)},this.scheduleNotes=function(a,c){a.forEach(function(a){b.scheduleNote(a,c)})}};var Polyhymnia=Polyhymnia||{};Polyhymnia.getAudioContext=function(){"use strict";return Polyhymnia.audioContext||(window.AudioContext=window.AudioContext||window.webkitAudioContext,Polyhymnia.audioContext=new AudioContext),Polyhymnia.audioContext},Polyhymnia.isSupported=function(){"use strict";return window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext?!0:!1},Polyhymnia.Context=function(a){"use strict";function b(a){var b=Polyhymnia.tokenize(a),c=Polyhymnia.parse(b,g.instruments);return f.setRules(c),c}function c(a){h.tempo=a}function d(a,b){g.timeSignature.num=a,g.timeSignature.den=b}function e(a){g.animCallback=a}if(!Polyhymnia.isSupported())return{play:function(){},stop:function(){},setParam:function(){},setRules:function(){},setTempo:function(){},setAnimCallback:function(){}};var f=new Polyhymnia.Generator;f.setParam("x",0),f.instruments={};var g=new Polyhymnia.Sequencer;g.generator=f;var h=new Polyhymnia.Metronome;if(h.sequencer=g,a&&a.tempo&&(h.tempo=a.tempo),a&&a.instruments)for(var i=0;i<a.instruments.length;i++){var j=a.instruments[i];g.instruments[j.name]=new Polyhymnia.Sampler({samples:j.samples})}return{parse:b,play:h.play,stop:h.stop,setParam:f.setParam,setTempo:c,setTimeSignature:d,setAnimCallback:e}};