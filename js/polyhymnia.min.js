/*!
 * Polyhymnia v0.3.0 (https://polyhymnia.io)
 *
 * Copyright (c) 2014-2015 Jonathan Hise Kaldma
 * Released under the MIT license
 */
var Polyhymnia=Polyhymnia||{};Polyhymnia.noteType={PAUSE:"pause",NOTE:"note",CHORD:"chord",DEGREE_NOTE:"degree note",DEGREE_CHORD:"degree chord",DRUM:"drum"},Polyhymnia.symbolType={NAME:"name",EQUAL:"equal",REFERENCE:"reference",INSTRUMENT:"instrument",NOTE:"note",CONDITION:"condition",COMMENT:"comment"},Polyhymnia.parse=function(a){"use strict";function b(a,b,c){v.push({type:a,start:b||n.start,end:c||n.end})}function c(a,b,c){b=b||n.start,c=c||n.end,w.push({error:a,start:b,end:c}),void 0!==b&&void 0!==c&&v.push({type:"error",error:a,start:b,end:c})}function d(){s=t.length>0,n=t.length>0?t.shift():{},o=t.length>0?t[0]:{},n.type==p.COMMENT&&(v.push({type:"comment",start:n.start,end:n.end}),d())}function e(){for(;n&&n.type==p.EOL;)d()}function f(){return s?n.type==p.EOL?!0:n.type==p.NAME&&o&&o.type==p.EQUAL?!0:!1:!0}function g(){var a="",e=[];for(o&&o.type==p.EQUAL&&(n.type==p.NAME?(a=n.value,b(r.NAME)):c(n.type==p.NOTE?n.str+" is not a valid name, since it's a note":n.type==p.CHORD?n.str+" is not a valid name, since it's a chord":n.type==p.DEGREE_CHORD?n.str+" is not a valid name, since it's a degree chord":n.type==p.DRUM_HIT?n.str+" is not a valid name, since it's a drum hit":n.str+" is not a valid name"),d(),b(r.EQUAL),d(),n.type==p.EOL&&d());!f();)e.push(h()),d();return{name:a,definitions:e}}function h(){var a,b;switch(n.type==p.LEFT_PAREN&&(a=m()),n.type==p.INSTRUMENT&&(b=i()),n.type){case p.NOTE:case p.CHORD:case p.DEGREE_NOTE:case p.DEGREE_CHORD:case p.DRUM_HIT:case p.PAUSE:var d=k();return{condition:a,instrument:b,pattern:d};case p.NAME:var e=j();return{condition:a,instrument:b,sequence:e};default:return c("Expected a sequence or pattern"),{}}}function i(){var a={name:n.value,start:n.start,end:n.end};return b(r.INSTRUMENT),d(),a}function j(){for(var a=[];n.type!==p.EOL&&s;)n.type==p.NAME?(a.push({name:n.value,start:n.start,end:n.end}),b(r.REFERENCE)):(c("Expected a rule name"),a.push({name:"",start:n.start,end:n.end})),d();return a}function k(){for(var a=[],b=[a];n.type!==p.EOL&&s;)n.type==p.BAR?(a=[],b.push(a),d()):a.push(l());return b}function l(){var a={start:n.start,end:n.end},e=!0;switch(n.type){case p.NOTE:a.type=q.NOTE,a.note=n.note,a.octave=n.octave,a.velocity=n.velocity;break;case p.CHORD:a.type=q.CHORD,a.note=n.note,a.octave=n.octave,a.chord=n.chord,a.velocity=n.velocity;break;case p.DEGREE_NOTE:a.type=q.DEGREE_NOTE,a.value=n.value,a.velocity=n.velocity;break;case p.DEGREE_CHORD:a.type=q.DEGREE_CHORD,a.value=n.value,a.velocity=n.velocity;break;case p.DRUM_HIT:a.type=q.DRUM,a.value=n.value,a.velocity=n.velocity;break;case p.PAUSE:a.type=q.PAUSE;break;default:c("Expected a note, chord, drum hit or pause"),e=!1,a.type=q.PAUSE}return e&&b(r.NOTE),d(),a}function m(){for(var a=n.start,e=n.end,f=[];s&&n.type!==p.EOL;){if(f.push(n),e=n.end,n.type==p.RIGHT_PAREN){d();break}d()}var g,h,i;if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.NUMBER&&f[2].type==p.GREATER_THAN&&f[3].type==p.PARAM&&f[4].type==p.RIGHT_PAREN)h=f[1].value,i=f[3].value;else if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.NUMBER&&f[2].type==p.LESS_THAN&&f[3].type==p.PARAM&&f[4].type==p.RIGHT_PAREN)g=f[1].value,i=f[3].value;else if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.PARAM&&f[2].type==p.GREATER_THAN&&f[3].type==p.NUMBER&&f[4].type==p.RIGHT_PAREN)i=f[1].value,g=f[3].value;else if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.PARAM&&f[2].type==p.LESS_THAN&&f[3].type==p.NUMBER&&f[4].type==p.RIGHT_PAREN)i=f[1].value,h=f[3].value;else if(7==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.NUMBER&&f[2].type==p.LESS_THAN&&f[3].type==p.PARAM&&f[4].type==p.LESS_THAN&&f[5].type==p.NUMBER&&f[6].type==p.RIGHT_PAREN)g=f[1].value,i=f[3].value,h=f[5].value;else{if(7!=f.length||f[0].type!=p.LEFT_PAREN||f[1].type!=p.NUMBER||f[2].type!=p.GREATER_THAN||f[3].type!=p.PARAM||f[4].type!=p.GREATER_THAN||f[5].type!=p.NUMBER||f[6].type!=p.RIGHT_PAREN)return void c("Expected a condition",a,e);h=f[1].value,i=f[3].value,g=f[5].value}return b(r.CONDITION,a,e),{param:i,min:g,max:h}}var n,o,p=Polyhymnia.tokenType,q=Polyhymnia.noteType,r=Polyhymnia.symbolType,s=!0,t=a.slice(0),u=[],v=[],w=[];for(d(),e();s;)u.push(g()),e();return u.symbols=v,u.errors=w,u};var Polyhymnia=Polyhymnia||{};Polyhymnia.tokenType={NAME:"name",NUMBER:"number",INSTRUMENT:"instrument",PAUSE:"pause",NOTE:"note",CHORD:"chord",DEGREE_NOTE:"degree note",DEGREE_CHORD:"degree chord",DRUM_HIT:"drum hit",BAR:"bar",EQUAL:"equal",LEFT_PAREN:"left paren",RIGHT_PAREN:"right paren",PARAM:"param",LESS_THAN:"less than",GREATER_THAN:"greater than",COMMENT:"comment",ERROR:"error",EOL:"eol"},Polyhymnia.tokenize=function(a){"use strict";function b(){O++,f=O<K.length,f&&(g=K[O],N++)}function c(){for(var a="";f&&-1===w.indexOf(g);)a+=g,b();return a}function d(a){return a?parseInt(a):void 0}function e(a){if(a){var b=a.substr(1),c=parseInt(b);return isNaN(c)?b:c}return void 0}var f,g,h=Polyhymnia.tokenType,i="[A-Z][a-zA-Z0-9_]*",j="[a-z][a-zA-Z0-9_]*",k=i+":",l="-?(([1-9][0-9]*)|0)(\\.[0-9]*)?",m="(-2|-1|[0-8])?",n="([CDEFGAB][#b]?)"+m,o=n+"((?:M|m|dom|aug|dim)7?)",p="([1-7])",q="((?:(?:I|II|III|IV|V|VI|VII)\\+?|(?:i|ii|iii|iv|v|vi|vii)°?)7?)",r="([xXoO])",s="(\\.(?:(?:ppp|fff|pp|ff|mp|mf|p|f)|(?:12[0-7]|1[0-1][0-9]|[1-9][0-9]|[0-9])))?",t="\n",u=" ",v="	",w="()\n	 ",x="*",y="default",z="condition",A=new RegExp("^"+i+"$"),B=new RegExp("^"+j+"$"),C=new RegExp("^"+k+"$"),D=new RegExp("^"+l+"$"),E=new RegExp("^"+n+s+"$"),F=new RegExp("^"+o+s+"$"),G=new RegExp("^"+p+s+"$"),H=new RegExp("^"+q+s+"$"),I=new RegExp("^"+r+s+"$"),J=a.replace("\r",""),K=J.split(""),L=[],M=1,N=-1,O=-1;b();for(var P,Q,R,S,T,U,V,W=y;f;){if(S=void 0,P=void 0,Q=M,R=N,g==t)M++,P={type:h.EOL},W=y,b();else if(g==u||g==v)b();else if("("==g)P={type:h.LEFT_PAREN,str:"("},W=z,b();else if(")"==g)P={type:h.RIGHT_PAREN,str:")"},W=y,b();else if(g==x){for(S="";f&&g!==t;)S+=g,b();P={type:h.COMMENT,value:S,str:S}}else S=c(),W==z?P=">"==S?{type:h.GREATER_THAN,str:S}:"<"==S?{type:h.LESS_THAN,str:S}:-1!==S.search(B)?{type:h.PARAM,value:S,str:S}:-1!==S.search(D)?{type:h.NUMBER,value:parseFloat(S),str:S}:{type:h.ERROR,value:S,str:S}:"="==S?P={type:h.EQUAL,str:S}:"_"==S?P={type:h.PAUSE,str:S}:"|"==S?P={type:h.BAR,str:S}:-1!==S.search(I)?(T=S.match(I),V=e(T[2]),P={type:h.DRUM_HIT,value:T[1],velocity:V,str:S}):-1!==S.search(E)?(T=S.match(E),U=d(T[2]),V=e(T[3]),P={type:h.NOTE,note:T[1],octave:U,velocity:V,str:S}):-1!==S.search(F)?(T=S.match(F),U=d(T[2]),V=e(T[4]),P={type:h.CHORD,note:T[1],octave:U,chord:T[3],velocity:V,str:S}):-1!==S.search(G)?(T=S.match(G),V=e(T[2]),P={type:h.DEGREE_NOTE,value:T[1],velocity:V,str:S}):-1!==S.search(H)?(T=S.match(H),V=e(T[2]),P={type:h.DEGREE_CHORD,value:T[1],velocity:V,str:S}):P=-1!==S.search(A)?{type:h.NAME,value:S}:-1!==S.search(C)?{type:h.INSTRUMENT,value:S.substr(0,S.length-1),str:S}:{type:h.ERROR,value:S,str:S};void 0!==P&&(P.line=Q,P.start=R,P.end=S?R+S.length:R+1,L.push(P))}return L};var Polyhymnia=Polyhymnia||{};Polyhymnia.validate=function(a,b){"use strict";function c(b,c,d){a.symbols=a.symbols.filter(function(a){return!(a.start>=c&&a.end<=d)}),a.errors.push({error:b,start:c,end:d}),a.symbols.push({type:"error",error:b,start:c,end:d})}function d(a,b){a.definitions.forEach(function(a){a.sequence?a.sequence.forEach(function(a){f(a,b)}):a.instrument&&e(a.instrument)})}function e(a){a.invalid||b&&!b[a.name]&&(c("There is no instrument called "+a.name,a.start,a.end),a.invalid=!0)}function f(a,b){if(!a.invalid){var e=g[a.name];e?-1!==b.indexOf(a.name)?(c(a.name+" cannot reference itself",a.start,a.end),a.invalid=!0):d(e,b+"/"+a.name):(c("There is no rule called "+a.name,a.start,a.end),a.invalid=!0)}}var g=(Polyhymnia.noteType,Polyhymnia.symbolType,{});return a.forEach(function(a){g[a.name]=a}),a.forEach(function(a){d(a,a.name)}),a.symbols=a.symbols.sort(function(a,b){return a.start-b.start}),a};var Polyhymnia=Polyhymnia||{};Polyhymnia.Chords=function(){"use strict";var a={},b={M:[0,4,7],m:[0,3,7],M7:[0,4,7,11],m7:[0,3,7,10],dom7:[0,4,7,10],aug:[0,4,8],aug7:[0,4,8,10],dim:[0,3,6],dim7:[0,3,6,9]};return a.toName=function(a){a.forEach(function(b,c){a[c]=b%12});for(var c in b){var d=b[c];if(d.length==a.length){for(var e=!0,f=0;f<d.length;f++)d[f]!=a[f]&&(e=!1);if(e)return c}}return""},a.fromName=function(a,c,d){return c=c?Polyhymnia.Notes.fromName(c,d):0,a in b?b[a].map(function(a){return a+c}):[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Degrees=function(){"use strict";function a(a){function b(a){return a.toUpperCase()}function e(a){return a}var f={};return c.forEach(function(c,g){function h(b){return b+a[g]}f[b(c)]=d.maj.map(h),f[e(c)]=d.min.map(h),f[b(c)+"7"]=d.maj7.map(h),f[e(c)+"7"]=d.min7.map(h),f[b(c)+"+"]=d.aug.map(h),f[b(c)+"+7"]=d.aug7.map(h),f[e(c)+"°"]=d.dim.map(h),f[e(c)+"°7"]=d.dim7.map(h)}),f}var b={},c=["i","ii","iii","iv","v","vi","vii"],d={maj:[0,4,7],min:[0,3,7],maj7:[0,4,7,11],min7:[0,3,7,10],aug:[0,4,8],aug7:[0,4,8,10],dim:[0,3,6],dim7:[0,3,6,9]};return b.toName=function(b,c,d){d=d?Polyhymnia.Scales.fromName(d,c):Polyhymnia.Scales.fromName("major",c);var e=Math.floor(b[0]/12);b.forEach(function(a,c){b[c]=a-12*e+60});var f=a(d);for(var g in f){var h=f[g];if(h.length==b.length){for(var i=!0,j=0;j<h.length;j++)h[j]!=b[j]&&(i=!1);if(i)return g}}return""},b.fromName=function(b,c,d){d=d?Polyhymnia.Scales.fromName(d,c):Polyhymnia.Scales.fromName("major",c);var e=a(d);return b in e?e[b]:[]},b}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Notes=function(){"use strict";var a={},b={C:0,"B#":0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11},c={0:"C",1:"C#",2:"D",3:"D#",4:"E",5:"F",6:"F#",7:"G",8:"G#",9:"A",10:"A#",11:"B"};return a.toName=function(a){return c[a%12]},a.fromName=function(a,c){return c||(c=3),c+=2,a in b?b[a]+12*c:0},a.toFrequency=function(a){return 440*Math.pow(2,(a-69)/12)},a.fromFrequency=function(a){return Math.round(69+12*Math.log(.0022727272727*a)/Math.LN2)},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Scales=function(){"use strict";var a={},b={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],"pentatonic-major":[0,2,4,7,9],"pentatonic-minor":[0,3,5,7,10]};return a.toName=function(a){a.forEach(function(b,c){a[c]=b%12});for(var c in b){var d=b[c];if(d.length==a.length){for(var e=!0,f=0;f<d.length;f++)d[f]!=a[f]&&(e=!1);if(e)return c}}return""},a.fromName=function(a,c,d){return c=c?Polyhymnia.Notes.fromName(c,d):60,a in b?b[a].map(function(a){return a+c}):[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Velocities=function(){"use strict";var a={},b={ppp:16,pp:32,p:48,mp:64,mf:80,f:96,ff:112,fff:127};return a.fromName=function(a){return a in b?b[a]:[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Metronome=function(){"use strict";function a(){if(!document.hidden)for(;f<h.currentTime+c.lookahead;)c.sequencer.scheduleTick(e,f),b();g=window.setTimeout(a,c.interval)}function b(){var a=60/c.tempo;f+=a/c.ticksPerBeat,e++}var c=this;this.tempo=120,this.ticksPerBeat=48,this.interval=25,this.lookahead=.1,this.sequencer=null;var d=!1,e=0,f=0,g=0,h=Polyhymnia.getAudioContext();this.play=function(){d||(e=0,f=h.currentTime,a(),d=!0)},this.stop=function(){d&&(window.clearTimeout(g),d=!1)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Sampler=function(a){"use strict";function b(a,b){function d(){k++,k>=l&&c()}var e=new XMLHttpRequest;e.open("GET",b,!0),e.responseType="arraybuffer",e.onload=function(){g.decodeAudioData(e.response,function(c){console.log("Loaded "+b),j[a]=c,d()},function(){console.log("Error decoding audio file: "+b),d()})},e.send()}function c(){for(var a=0;128>a;a++)if(void 0!==j[a])i[a]={buffer:j[a],pitch:1};else{for(var b,c,d=0;a>d;d++)j[d]&&(b=d);for(var e=127;e>a;e--)j[e]&&(c=e);var f;if(c&&b?f=a-b>c-a?c:b:c?f=c:b&&(f=b),f){var g=Polyhymnia.Notes.toFrequency(a),h=Polyhymnia.Notes.toFrequency(f),k=g/h;i[a]={buffer:j[f],pitch:k,orig:f}}}}var d=this;a=a||{};var e=a.attack||.01,f=a.release||.7,g=Polyhymnia.getAudioContext(),h={},i=[],j=[],k=0,l=0;a&&a.samples&&a.samples.forEach(function(a){var c=a.root||"C",d=a.octave||4,e=a.url,f=Polyhymnia.Notes.fromName(c,d);b(f,e),l++}),this.scheduleNoteOn=function(a,b,c){h[a]&&d.scheduleNoteOff(a,b,c);var f={volume:b/127};f.gain=g.createGain(),f.gain.connect(g.destination),f.gain.gain.value=0,f.source=g.createBufferSource(),f.source.buffer=i[a].buffer,f.source.playbackRate.value=i[a].pitch,f.source.connect(f.gain),f.source.start(c),f.gain.gain.setValueAtTime(.001,c),f.gain.gain.exponentialRampToValueAtTime(f.volume,c+e),h[a]=f},this.scheduleNoteOff=function(a,b,c){var d=h[a];d&&(d.gain.gain.cancelScheduledValues(c),d.gain.gain.setValueAtTime(d.volume,c),d.gain.gain.exponentialRampToValueAtTime(.001,c+f),delete h[a])},this.allNotesOff=function(){var a=g.currentTime;for(var b in h)d.scheduleNoteOff(b,0,a)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.getAudioContext=function(){"use strict";return Polyhymnia.audioContext||(window.AudioContext=window.AudioContext||window.webkitAudioContext,Polyhymnia.audioContext=new AudioContext),Polyhymnia.audioContext},Polyhymnia.isSupported=function(){"use strict";return window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext?!0:!1},Polyhymnia.Context=function(a){"use strict";function b(a){var b=Polyhymnia.tokenize(a),c=Polyhymnia.parse(b);return c=Polyhymnia.validate(c,k.instruments),j.setRules(c),c}function c(){l.play()}function d(){l.stop(),k.stop(),j.reset()}function e(a){l.tempo=a}function f(a,b){k.timeSignature.num=a,k.timeSignature.den=b}function g(a){j.tonic=a}function h(a){j.scale=a}function i(a){k.animCallback=a}if(!Polyhymnia.isSupported())return{play:function(){},stop:function(){},setParam:function(){},setRules:function(){},setTempo:function(){},setAnimCallback:function(){}};var j=new Polyhymnia.Generator;j.setParam("x",0),j.instruments={};var k=new Polyhymnia.Sequencer;k.generator=j;var l=new Polyhymnia.Metronome;return l.sequencer=k,a&&a.tempo&&(l.tempo=a.tempo),a&&a.instruments&&a.instruments.forEach(function(a){k.instruments[a.name]=new Polyhymnia.Sampler(a)}),{parse:b,play:c,stop:d,setParam:j.setParam,setTempo:e,setTonic:g,setScale:h,setTimeSignature:f,setAnimCallback:i}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Generator=function(){"use strict";function a(b){if(!b)return{name:"",definitions:[],length:0};var c={name:b.name,definitions:[]};return b.definitions.forEach(function(b){var d=0;if(b.sequence){var e=[];b.sequence.forEach(function(b){var c;if(b.invalid)c=a();else{var d=k[b.name];c=a(d)}c.start=b.start,c.end=b.end,e.push(c)}),d=e.reduce(function(a,b){return a+b.length},0),c.definitions.push({condition:b.condition,instrument:b.instrument,sequence:e,index:0,length:d})}else b.pattern&&(d=b.pattern.length,c.definitions.push({condition:b.condition,instrument:b.instrument,pattern:b.pattern,index:0,length:d}))}),c.length=c.definitions.reduce(function(a,b){return a>b.length?a:b.length},0),c}function b(a){var c=!0,d=0;return a.definitions.forEach(function(a){if(a.sequence){var e=a.sequence[a.index],f=b(e);f&&a.index++,d=a.sequence.length}else a.pattern&&(a.index++,d=a.pattern.length);a.index>=d?a.index=0:c=!1}),c}function c(a,b){var d=e(a.definitions),g=[],h=[];return d.forEach(function(a){var d;if(b?d=b:a.instrument&&(d=a.instrument.name),a.sequence){g.push({name:a.sequence[a.index].name,start:a.sequence[a.index].start,end:a.sequence[a.index].end});var e=c(a.sequence[a.index],d);e.references.forEach(function(a){g.push(a)}),e.patterns.forEach(function(a){h.push(a)})}else if(a.pattern){var i=a.pattern[a.index].map(f);h.push({instrument:d,pattern:i})}}),{references:g,patterns:h}}function d(a){a.definitions.forEach(function(a){a.index=0,a.sequence&&a.sequence.forEach(function(a){d(a)})})}function e(a){var b=[];return a.forEach(function(a){var c=a.condition;if(c){var d=h.getParam(c.param),e=void 0!==c.min?c.min:-(1/0),f=void 0!==c.max?c.max:1/0;d>=e&&f>d&&b.push(a)}else b.push(a)}),b}function f(a){var b;switch(a.type){case g.NOTE:b=[Polyhymnia.Notes.fromName(a.note,a.octave)];break;case g.CHORD:b=Polyhymnia.Chords.fromName(a.chord,a.note,a.octave);break;case g.DEGREE_NOTE:b=[Polyhymnia.Scales.fromName(h.scale,h.tonic)[a.value-1]];break;case g.DEGREE_CHORD:b=Polyhymnia.Degrees.fromName(a.value,h.tonic,h.scale);break;case g.DRUM:b=[Polyhymnia.Notes.fromName("C")];break;case g.PAUSE:b=[void 0];break;default:b=[void 0]}var c;c="string"==typeof a.velocity?Polyhymnia.Velocities.fromName(a.velocity):a.velocity?a.velocity:"X"===a.value||"O"===a.value?127:"x"===a.value||"o"===a.value?64:72;var d=b.map(function(b){return{key:b,velocity:c,start:a.start,end:a.end}});return 1==d.length?d[0]:d}var g=Polyhymnia.noteType,h=this;this.tonic="C",this.scale="major";var i="Play",j={},k=null,l=null,m=0;this.setParam=function(a,b){j[a]=b},this.getParam=function(a){return j[a]||0},this.getCurrentBar=function(){return c(l)},this.step=function(){m++,b(l)},this.reset=function(){d(l)},this.setRules=function(c){k={},c.length>1?(c.forEach(function(a){k[a.name]=a}),l=a(k[i])):l=a(c[0]),m%=l.length;for(var d=0;m>d;d++)b(l)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Sequencer=function(){"use strict";function a(a,b,d){c.instruments[a]&&c.instruments[a].scheduleNoteOn(b.key,b.velocity,d)}function b(a,b,d){c.instruments[a]&&c.instruments[a].scheduleNoteOff(b.key,b.velocity,d)}var c=(Polyhymnia.noteType,this);this.instruments={},this.timeSignature={num:4,den:4},this.ticksPerQuarter=48,this.generator=null,this.animCallback=void 0;var d=[],e=Polyhymnia.getAudioContext();this.scheduleTick=function(f,g){var h=4*c.timeSignature.num/c.timeSignature.den,i=c.ticksPerQuarter*h,j=f%i;0===j&&(f>0&&c.generator.step(),d=c.generator.getCurrentBar());for(var k=[],l=0;l<d.patterns.length;l++){var m=d.patterns[l].instrument,n=d.patterns[l].pattern,o=Math.round(i/n.length),p=Math.floor(j/o);if(!m)if(c.instruments.Piano)m="Piano";else for(var q in c.instruments){m=q;break}if(p<n.length){var r=n[p];Array.isArray(r)||(r=[r]);for(var s=0;s<r.length;s++)r[s].key&&(j%o===0&&a(m,r[s],g),j%o===o-1&&b(m,r[s],g)),k.push({start:r[s].start,end:r[s].end})}}for(var t=0;t<d.references.length;t++)k.push({start:d.references[t].start,end:d.references[t].end});k=k.sort(function(a,b){return a.start-b.start});var u=g-e.currentTime;k.length>0&&c.animCallback&&window.setTimeout(function(){c.animCallback(k)},u)},this.stop=function(){for(var a in c.instruments)c.instruments[a].allNotesOff()}};