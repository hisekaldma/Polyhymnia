var Polyhymnia=Polyhymnia||{};Polyhymnia.templates={editor:'<div class="polyhymnia-editor">    <div class="code">     <div class="display">       <div class="text"></div>       <div class="cursor-layer">         <div class="cursor blink">&nbsp;</div>       </div>     </div>     <textarea class="editor" spellcheck="false"></textarea>   </div>    <div class="controls">      <button class="play">       <svg x="0px" y="0px" width="18px" height="18px">         <path fill="none" stroke="#FF884D" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M16,9L2,17V1L16,9z"/>       </svg>     </button>      <button class="stop" style="display: none">       <svg x="0px" y="0px" width="18px" height="18px">         <rect x="2" y="2" fill="none" stroke="#FF884D" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" width="14" height="14"/>       </svg>     </button>      <div class="slider">       <div class="output hide">x = 0</div>       <input type="range" min="0" max="10" value="0" step="0.1" />     </div>      <div class="settings">           <input class="tempo" type="number" min="1" max="320" value="120" step="1" maxlength="3" /><label>bpm</label>       <select class="time">         <option>3/4</option>         <option selected>4/4</option>         <option>5/4</option>         <option>6/8</option>         <option>7/8</option>       </select>       <select class="tonic short">         <option selected>C</option>         <option>C#</option>         <option>D</option>         <option>Db</option>         <option>D#</option>         <option>E</option>         <option>Eb</option>         <option>F</option>         <option>F#</option>         <option>G</option>         <option>Gb</option>         <option>G#</option>         <option>A</option>         <option>Ab</option>         <option>A#</option>         <option>B</option>         <option>Bb</option>       </select>       <select class="scale">         <option value="major" selected>maj</option>         <option value="minor">min</option>       </select>     </div>   </div>    <div class="not-supported" style="display: none">     Your browser doesn’t support web audio. Why don’t you try <a href="https://www.google.com/chrome/browser/desktop/">Chrome</a>?   </div> </div>'};var Polyhymnia=Polyhymnia||{};Polyhymnia.Editor=function(a,b){"use strict";function c(){e(),o.play(),r.style.display="none",s.style.display="block",G=!0}function d(){o.stop(),r.style.display="block",s.style.display="none",G=!1,m([])}function e(){var a=o.parse(z.value);p=a.symbols,k()}function f(){""===v.value?v.value=120:v.value>parseInt(v.max)?v.value=v.max:v.value<parseInt(v.min)&&(v.value=v.min),o.setTempo(v.value)}function g(){o.setTonic(w.value),1==w.value.length?w.classList.add("short"):w.classList.remove("short")}function h(){o.setScale(x.value)}function i(){var a=y.value.split("/"),b=parseInt(a[0]),c=parseInt(a[1]);o.setTimeSignature(b,c)}function j(){o.setParam("x",t.valueAsNumber),u.textContent="x = "+t.value,u.classList.remove("hide"),u.classList.add("show");var a=t.value/(t.max-t.min),b=8*(1-a)-8*a;u.style.left=a*t.offsetWidth-u.offsetWidth/2+b+"px",setTimeout(function(){u.classList.add("hide"),u.classList.remove("show")},2e3)}function k(){for(var a=z.value,b="",c=0,d=0;d<a.length;d++)c<p.length&&p[c].start==d&&(b+='<span class="'+p[c].type+'" data-start="'+p[c].start+'">'),b+=a.charAt(d),c<p.length&&p[c].end==d+1&&(b+="</span>",c++);B.innerHTML=b,E=[];for(var e=B.querySelectorAll(".note"),f=0;f<e.length;f++)E.push({elem:e[f],start:e[f].dataset.start})}function l(){var a="forward"==z.selectionDirection?z.selectionEnd:z.selectionStart;if(document.activeElement===z){if(C.style.display="block",a!==F){F=a;var b=C.getBoundingClientRect(),c=b.height-(C.offsetHeight-C.clientHeight),d=b.width-(C.offsetWidth-C.clientWidth),e=z.value.substr(0,F).split("\n"),f=(e.length-1)*c,g=e[e.length-1].length*d;C.classList.remove("blink"),C.style.top=f+"px",C.style.left=g-1+"px";{C.offsetWidth}C.classList.add("blink")}}else C.style.display="none";A.scrollTop=z.scrollTop,window.requestAnimationFrame(l)}function m(a){for(var b=0;b<E.length;b++){for(var c=!1,d=0;d<a.length;d++)E[b].start==a[d].start&&(c=!0);E[b].elem.className=G&&c?"playing":"note"}}var n=a.textContent,o=b,p=[];o.setAnimCallback(m),a.innerHTML=Polyhymnia.templates.editor;var q=a.querySelector(".controls"),r=a.querySelector(".play"),s=a.querySelector(".stop"),t=a.querySelector(".slider input"),u=a.querySelector(".slider .output"),v=a.querySelector(".settings .tempo"),w=a.querySelector(".settings .tonic"),x=a.querySelector(".settings .scale"),y=a.querySelector(".settings .time"),z=a.querySelector(".code .editor"),A=a.querySelector(".code .display"),B=a.querySelector(".code .text"),C=a.querySelector(".code .cursor"),D=a.querySelector(".not-supported"),E=[];z.value=n;var F,G=!1;Polyhymnia.isSupported()?(r.addEventListener("click",c),s.addEventListener("click",d),t.addEventListener("input",j),v.addEventListener("input",f),w.addEventListener("input",g),x.addEventListener("input",h),y.addEventListener("input",i),z.addEventListener("input",e)):(q.style.display="none",D.style.display="block"),e(),window.requestAnimationFrame(l)};var Polyhymnia=Polyhymnia||{};Polyhymnia.Generator=function(){"use strict";function a(b){if(!b)return{name:"",definitions:[]};var c={name:b.name,definitions:[]};return b.definitions.forEach(function(b){if(b.sequence){for(var d=[],e=0;e<b.sequence.length;e++){var f=k[b.sequence[e]];d.push(a(f))}c.definitions.push({condition:b.condition,sequence:d,index:0})}else b.pattern&&c.definitions.push({condition:b.condition,pattern:b.pattern,instrument:b.instrument})}),c}function b(a){var c=!0;return a.definitions.forEach(function(a){if(a.sequence){var d=a.sequence[a.index],e=b(d);e&&a.index++,a.index>=a.sequence.length?a.index=0:c=!1}else a.pattern}),c}function c(a){var b=e(a.definitions),d=[];return b.forEach(function(a){if(a.sequence){var b=c(a.sequence[a.index]);b.forEach(function(a){d.push(a)})}else if(a.pattern){var e=a.pattern.map(f);d.push({instrument:a.instrument,pattern:e})}}),d}function d(a,b){for(var c=0;c<a.definitions.length;c++){var e=a.definitions[c],f=b.definitions.length>c?b.definitions[c]:void 0;if(e&&f&&e.sequence&&f.sequence){f.index=e.index;var g=e.sequence[e.index],h=f.sequence[f.index];d(g,h)}}}function e(a){var b=[];return a.forEach(function(a){var c=a.condition;if(c){var d=h.getParam(c.param),e=void 0!==c.min?c.min:-(1/0),f=void 0!==c.max?c.max:1/0;d>=e&&f>d&&b.push(a)}else b.push(a)}),b}function f(a){var b;switch(a.type){case g.NOTE:b=[Polyhymnia.Notes.fromName(a.note,a.octave)];break;case g.CHORD:b=Polyhymnia.Chords.fromName(a.chord,a.note,a.octave);break;case g.DEGREE_NOTE:b=[Polyhymnia.Scales.fromName(h.scale,h.tonic)[a.value-1]];break;case g.DEGREE_CHORD:b=Polyhymnia.Degrees.fromName(a.value,h.tonic,h.scale);break;case g.DRUM:b=[Polyhymnia.Notes.fromName("C")];break;case g.PAUSE:b=[void 0];break;default:b=[void 0]}var c;c="string"==typeof a.velocity?Polyhymnia.Velocities.fromName(a.velocity):a.velocity?a.velocity:"X"===a.value||"O"===a.value?127:"x"===a.value||"o"===a.value?64:72;var d=b.map(function(b){return{key:b,velocity:c,start:a.start,end:a.end}});return 1==d.length?d[0]:d}var g=Polyhymnia.noteType,h=this;this.tonic="C",this.scale="major";var i="Play",j={},k=null,l=null;this.setParam=function(a,b){j[a]=b},this.getParam=function(a){return j[a]||0},this.getPatterns=function(){return c(l)},this.step=function(){b(l)},this.setRules=function(b){k={},b.forEach(function(a){k[a.name]=a});var c=l;l=a(k[i]),c&&d(c,l)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.noteType={PAUSE:"pause",NOTE:"note",CHORD:"chord",DEGREE_NOTE:"degree note",DEGREE_CHORD:"degree chord",DRUM:"drum"},Polyhymnia.symbolType={NAME:"name",ARROW:"arrow",REFERENCE:"reference",INSTRUMENT:"instrument",NOTE:"note",CONDITION:"condition"},Polyhymnia.parse=function(a,b){"use strict";function c(a,b,c){v.push({type:a,start:b||n.start,end:c||n.end})}function d(a,b,c){w.push({error:a,start:b||n.start,end:c||n.end}),v.push({type:"error",error:a,start:b||n.start,end:c||n.end})}function e(){s=t.length>0,n=t.length>0?t.shift():{},o=t.length>0?t[0]:{}}function f(){for(;n&&n.type==p.EOL;)e()}function g(){return s?n.type==p.EOL?!0:n.type==p.NAME&&o&&o.type==p.ARROW?!0:!1:!0}function h(){var a="",b=[];for(n.type==p.NAME?(a=n.value,c(r.NAME)):d("Rules must start with a name"),e(),n.type==p.ARROW?c(r.ARROW):d("Expected ->"),e(),n.type==p.EOL&&e();!g();)b.push(i()),e();return{name:a,definitions:b}}function i(){var a;if(n.type==p.LEFT_PAREN&&(a=m()),n.type==p.INSTRUMENT){var b=k();return{condition:a,instrument:b.instrument,pattern:b.pattern}}if(n.type==p.NAME){var c=j();return{condition:a,sequence:c}}return d("Expected a sequence or pattern"),{}}function j(){for(var a=[];n.type!==p.EOL&&s;)n.type==p.NAME?(a.push(n.value),c(r.REFERENCE)):(d("Expected a rule name"),a.push("")),e();return a}function k(){var a=n.value;b&&!b[a]?d("There is no instrument "+a):c(r.INSTRUMENT),e();for(var f=[];n.type!==p.EOL&&s;)f.push(l());return{instrument:a,pattern:f}}function l(){var a={start:n.start,end:n.end},b=!0;switch(n.type){case p.NOTE:a.type=q.NOTE,a.note=n.note,a.octave=n.octave,a.velocity=n.velocity;break;case p.CHORD:a.type=q.CHORD,a.note=n.note,a.octave=n.octave,a.chord=n.chord,a.velocity=n.velocity;break;case p.DEGREE_NOTE:a.type=q.DEGREE_NOTE,a.value=n.value,a.velocity=n.velocity;break;case p.DEGREE_CHORD:a.type=q.DEGREE_CHORD,a.value=n.value,a.velocity=n.velocity;break;case p.DRUM_HIT:a.type=q.DRUM,a.value=n.value,a.velocity=n.velocity;break;case p.PAUSE:a.type=q.PAUSE;break;default:d("Expected a note, chord, drum hit or pause"),b=!1,a.type=q.PAUSE}return b&&c(r.NOTE),e(),a}function m(){for(var a=n.start,b=n.end,f=[];s&&n.type!==p.EOL;){if(f.push(n),b=n.end,n.type==p.RIGHT_PAREN){e();break}e()}var g,h,i;if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.NUMBER&&f[2].type==p.GREATER_THAN&&f[3].type==p.PARAM&&f[4].type==p.RIGHT_PAREN)h=f[1].value,i=f[3].value;else if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.NUMBER&&f[2].type==p.LESS_THAN&&f[3].type==p.PARAM&&f[4].type==p.RIGHT_PAREN)g=f[1].value,i=f[3].value;else if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.PARAM&&f[2].type==p.GREATER_THAN&&f[3].type==p.NUMBER&&f[4].type==p.RIGHT_PAREN)i=f[1].value,g=f[3].value;else if(5==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.PARAM&&f[2].type==p.LESS_THAN&&f[3].type==p.NUMBER&&f[4].type==p.RIGHT_PAREN)i=f[1].value,h=f[3].value;else if(7==f.length&&f[0].type==p.LEFT_PAREN&&f[1].type==p.NUMBER&&f[2].type==p.LESS_THAN&&f[3].type==p.PARAM&&f[4].type==p.LESS_THAN&&f[5].type==p.NUMBER&&f[6].type==p.RIGHT_PAREN)g=f[1].value,i=f[3].value,h=f[5].value;else{if(7!=f.length||f[0].type!=p.LEFT_PAREN||f[1].type!=p.NUMBER||f[2].type!=p.GREATER_THAN||f[3].type!=p.PARAM||f[4].type!=p.GREATER_THAN||f[5].type!=p.NUMBER||f[6].type!=p.RIGHT_PAREN)return void d("Expected a condition",a,b);h=f[1].value,i=f[3].value,g=f[5].value}return c(r.CONDITION,a,b),{param:i,min:g,max:h}}var n,o,p=Polyhymnia.tokenType,q=Polyhymnia.noteType,r=Polyhymnia.symbolType,s=!0,t=a.slice(0),u=[],v=[],w=[];for(e(),f();s;)u.push(h()),f();return u.forEach(function(a){a.definitions.forEach(function(a){a.sequence&&a.sequence.forEach(function(a){var b=u.some(function(b){return b.name==a});b||w.push({error:"There is no rule "+a})})})}),u.symbols=v,u.errors=w,u};var Polyhymnia=Polyhymnia||{};Polyhymnia.tokenType={NAME:"name",NUMBER:"number",INSTRUMENT:"instrument",PAUSE:"pause",NOTE:"note",CHORD:"chord",DEGREE_NOTE:"degree note",DEGREE_CHORD:"degree chord",DRUM_HIT:"drum hit",ARROW:"arrow",LEFT_PAREN:"left paren",RIGHT_PAREN:"right paren",PARAM:"param",LESS_THAN:"less than",GREATER_THAN:"greater than",COMMENT:"comment",ERROR:"error",EOL:"eol"},Polyhymnia.tokenize=function(a){"use strict";function b(){O++,f=O<K.length,f&&(g=K[O],N++)}function c(){for(var a="";f&&-1===w.indexOf(g);)a+=g,b();return a}function d(a){return a?parseInt(a):void 0}function e(a){if(a){var b=a.substr(1),c=parseInt(b);return isNaN(c)?b:c}return void 0}var f,g,h=Polyhymnia.tokenType,i="[A-Z][a-zA-Z0-9_]*",j="[a-z][a-zA-Z0-9_]*",k=i+":",l="-?(([1-9][0-9]*)|0)(\\.[0-9]*)?",m="(-2|-1|[0-8])?",n="([CDEFGAB][#b]?)"+m,o=n+"((?:M|m|dom|aug|dim)7?)",p="([1-7])",q="((?:(?:I|II|III|IV|V|VI|VII)\\+?|(?:i|ii|iii|iv|v|vi|vii)°?)7?)",r="([xX])",s="(\\.(?:(?:ppp|fff|pp|ff|mp|mf|p|f)|(?:12[0-7]|1[0-1][0-9]|[1-9][0-9]|[0-9])))?",t="\n",u=" ",v="	",w="()\n	 ",x="sequence",y="pattern",z="condition",A=new RegExp("^"+i+"$"),B=new RegExp("^"+j+"$"),C=new RegExp("^"+k+"$"),D=new RegExp("^"+l+"$"),E=new RegExp("^"+n+s+"$"),F=new RegExp("^"+o+s+"$"),G=new RegExp("^"+p+s+"$"),H=new RegExp("^"+q+s+"$"),I=new RegExp("^"+r+s+"$"),J=a.replace("\r",""),K=J.split(""),L=[],M=1,N=-1,O=-1;b();for(var P,Q,R,S,T,U,V,W=x;f;)S=void 0,P=void 0,Q=M,R=N,g==t?(M++,P={type:h.EOL},W=x,b()):g==u||g==v?b():"("==g?(P={type:h.LEFT_PAREN},W=z,b()):")"==g?(P={type:h.RIGHT_PAREN},W=x,b()):(S=c(),W==z?P=">"==S?{type:h.GREATER_THAN}:"<"==S?{type:h.LESS_THAN}:-1!==S.search(B)?{type:h.PARAM,value:S}:-1!==S.search(D)?{type:h.NUMBER,value:parseFloat(S)}:{type:h.ERROR,value:S}:W==y?"_"==S?P={type:h.PAUSE}:-1!==S.search(I)?(T=S.match(I),V=e(T[2]),P={type:h.DRUM_HIT,value:T[1],velocity:V}):-1!==S.search(E)?(T=S.match(E),U=d(T[2]),V=e(T[3]),P={type:h.NOTE,note:T[1],octave:U,velocity:V}):-1!==S.search(F)?(T=S.match(F),U=d(T[2]),V=e(T[4]),P={type:h.CHORD,note:T[1],octave:U,chord:T[3],velocity:V}):-1!==S.search(G)?(T=S.match(G),V=e(T[2]),P={type:h.DEGREE_NOTE,value:T[1],velocity:V}):-1!==S.search(H)?(T=S.match(H),V=e(T[2]),P={type:h.DEGREE_CHORD,value:T[1],velocity:V}):P={type:h.ERROR,value:S}:"->"==S?P={type:h.ARROW}:-1!==S.search(A)?P={type:h.NAME,value:S}:-1!==S.search(C)?(P={type:h.INSTRUMENT,value:S.substr(0,S.length-1)},W=y):P={type:h.ERROR,value:S}),void 0!==P&&(P.line=Q,P.start=R,P.end=S?R+S.length:R+1,L.push(P));return L};var Polyhymnia=Polyhymnia||{};Polyhymnia.Chords=function(){"use strict";var a={},b={M:[0,4,7],m:[0,3,7],M7:[0,4,7,11],m7:[0,3,7,10],dom7:[0,4,7,10],aug:[0,4,8],aug7:[0,4,8,10],dim:[0,3,6],dim7:[0,3,6,9]};return a.toName=function(a){a.forEach(function(b,c){a[c]=b%12});for(var c in b){var d=b[c];if(d.length==a.length){for(var e=!0,f=0;f<d.length;f++)d[f]!=a[f]&&(e=!1);if(e)return c}}return""},a.fromName=function(a,c,d){return c=c?Polyhymnia.Notes.fromName(c,d):0,a in b?b[a].map(function(a){return a+c}):[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Degrees=function(){"use strict";function a(a){function b(a){return a.toUpperCase()}function e(a){return a}var f={};return c.forEach(function(c,g){function h(b){return b+a[g]}f[b(c)]=d.maj.map(h),f[e(c)]=d.min.map(h),f[b(c)+"7"]=d.maj7.map(h),f[e(c)+"7"]=d.min7.map(h),f[b(c)+"+"]=d.aug.map(h),f[b(c)+"+7"]=d.aug7.map(h),f[e(c)+"°"]=d.dim.map(h),f[e(c)+"°7"]=d.dim7.map(h)}),f}var b={},c=["i","ii","iii","iv","v","vi","vii"],d={maj:[0,4,7],min:[0,3,7],maj7:[0,4,7,11],min7:[0,3,7,10],aug:[0,4,8],aug7:[0,4,8,10],dim:[0,3,6],dim7:[0,3,6,9]};return b.toName=function(b,c,d){d=d?Polyhymnia.Scales.fromName(d,c):Polyhymnia.Scales.fromName("major",c);var e=Math.floor(b[0]/12);b.forEach(function(a,c){b[c]=a-12*e+60});var f=a(d);for(var g in f){var h=f[g];if(h.length==b.length){for(var i=!0,j=0;j<h.length;j++)h[j]!=b[j]&&(i=!1);if(i)return g}}return""},b.fromName=function(b,c,d){d=d?Polyhymnia.Scales.fromName(d,c):Polyhymnia.Scales.fromName("major",c);var e=a(d);return b in e?e[b]:[]},b}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Notes=function(){"use strict";var a={},b={C:0,"B#":0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11},c={0:"C",1:"C#",2:"D",3:"D#",4:"E",5:"F",6:"F#",7:"G",8:"G#",9:"A",10:"A#",11:"B"};return a.toName=function(a){return c[a%12]},a.fromName=function(a,c){return c||(c=3),c+=2,a in b?b[a]+12*c:0},a.toFrequency=function(a){return 440*Math.pow(2,(a-69)/12)},a.fromFrequency=function(a){return Math.round(69+12*Math.log(.0022727272727*a)/Math.LN2)},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Scales=function(){"use strict";var a={},b={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],"pentatonic-major":[0,2,4,7,9],"pentatonic-minor":[0,3,5,7,10]};return a.toName=function(a){a.forEach(function(b,c){a[c]=b%12});for(var c in b){var d=b[c];if(d.length==a.length){for(var e=!0,f=0;f<d.length;f++)d[f]!=a[f]&&(e=!1);if(e)return c}}return""},a.fromName=function(a,c,d){return c=c?Polyhymnia.Notes.fromName(c,d):60,a in b?b[a].map(function(a){return a+c}):[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Velocities=function(){"use strict";var a={},b={ppp:16,pp:32,p:48,mp:64,mf:80,f:96,ff:112,fff:127};return a.fromName=function(a){return a in b?b[a]:[]},a}();var Polyhymnia=Polyhymnia||{};Polyhymnia.Metronome=function(){"use strict";function a(){if(!document.hidden)for(;f<h.currentTime+c.lookahead;)c.sequencer.scheduleStep(e,f),b();g=window.setTimeout(a,c.interval)}function b(){var a=60/c.tempo;f+=a/c.stepsPerBeat,e++}var c=this;this.tempo=120,this.stepsPerBeat=16,this.interval=25,this.lookahead=.1,this.sequencer=null;var d=!1,e=0,f=0,g=0,h=Polyhymnia.getAudioContext();this.play=function(){d||(e=0,f=h.currentTime,a(),d=!0)},this.stop=function(){d&&(window.clearTimeout(g),d=!1)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Sampler=function(a){"use strict";function b(a,b){function e(){g++,g>=h&&c()}var i=new XMLHttpRequest;i.open("GET",b,!0),i.responseType="arraybuffer",i.onload=function(){d.decodeAudioData(i.response,function(c){console.log("Loaded "+b),f[a]=c,e()},function(){console.log("Error decoding audio file: "+b),e()})},i.send()}function c(){for(var a=0;128>a;a++)if(void 0!==f[a])e[a]={buffer:f[a],pitch:1};else{for(var b,c,d=0;a>d;d++)f[d]&&(b=d);for(var g=127;g>a;g--)f[g]&&(c=g);var h;if(c&&b?h=a-b>c-a?c:b:c?h=c:b&&(h=b),h){var i=Polyhymnia.Notes.toFrequency(a),j=Polyhymnia.Notes.toFrequency(h),k=i/j;e[a]={buffer:f[h],pitch:k,orig:h}}}}var d=Polyhymnia.getAudioContext(),e=[],f=[],g=0,h=0;a&&a.samples&&a.samples.forEach(function(a){var c=a.root||"C",d=a.octave||4,e=a.url,f=Polyhymnia.Notes.fromName(c,d);b(f,e),h++}),this.scheduleNote=function(a,b,c){var f=d.createGain();f.connect(d.destination),f.gain.value=b/127;var g=d.createBufferSource();g.buffer=e[a].buffer,g.playbackRate.value=e[a].pitch,g.connect(f),g.start(c)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Sequencer=function(){"use strict";function a(a,b,d){c.instruments[a]&&b.key&&c.instruments[a].scheduleNote(b.key,b.velocity,d)}function b(a){for(var b=[1,2,4,8,16,32,64],d=c.stepsPerBeat,e=0;e<b.length&&!(a<c.timeSignature.num*b[e]/4);e++)d=4*c.stepsPerBeat/b[e];return d}var c=(Polyhymnia.noteType,this);this.instruments={},this.timeSignature={num:4,den:4},this.stepsPerBeat=16,this.generator=null,this.animCallback=void 0;var d=[],e=Polyhymnia.getAudioContext();this.scheduleStep=function(f,g){var h=f%(c.stepsPerBeat*c.timeSignature.num);0===h&&(f>0&&c.generator.step(),d=c.generator.getPatterns());for(var i=[],j=0;j<d.length;j++){var k=d[j].instrument,l=d[j].pattern,m=b(l.length),n=Math.floor(h/m);if(n<l.length){var o=l[n];Array.isArray(o)||(o=[o]);for(var p=0;p<o.length;p++)h%m===0&&a(k,o[p],g),i.push(o[p])}}var q=g-e.currentTime;i.length>0&&c.animCallback&&window.setTimeout(function(){c.animCallback(i)},q)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.Synthesizer=function(a){"use strict";a=a||{};var b=a.wave||"square",c=a.attack||.05,d=a.decay||.1,e=a.sustain||.8,f=a.release||.3,g=Polyhymnia.getAudioContext();this.scheduleNote=function(a,h,i){var j=g.createGain();j.connect(g.destination),j.gain.value=0;var k=g.createOscillator();k.type=b,k.frequency.value=Polyhymnia.Notes.toFrequency(a),k.connect(j),k.start(i);var l=h/127;j.gain.linearRampToValueAtTime(0,i+1e-4),j.gain.linearRampToValueAtTime(l,i+c),j.gain.linearRampToValueAtTime(l*e,i+c+d),j.gain.linearRampToValueAtTime(0,i+c+d+f),k.stop(i+c+d+f+1e-4)}};var Polyhymnia=Polyhymnia||{};Polyhymnia.getAudioContext=function(){"use strict";return Polyhymnia.audioContext||(window.AudioContext=window.AudioContext||window.webkitAudioContext,Polyhymnia.audioContext=new AudioContext),Polyhymnia.audioContext},Polyhymnia.isSupported=function(){"use strict";return window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext?!0:!1},Polyhymnia.Context=function(a){"use strict";function b(a){var b=Polyhymnia.tokenize(a),c=Polyhymnia.parse(b,i.instruments);return h.setRules(c),c}function c(a){j.tempo=a}function d(a,b){i.timeSignature.num=a,i.timeSignature.den=b}function e(a){h.tonic=a}function f(a){h.scale=a}function g(a){i.animCallback=a}if(!Polyhymnia.isSupported())return{play:function(){},stop:function(){},setParam:function(){},setRules:function(){},setTempo:function(){},setAnimCallback:function(){}};var h=new Polyhymnia.Generator;h.setParam("x",0),h.instruments={};var i=new Polyhymnia.Sequencer;i.generator=h;var j=new Polyhymnia.Metronome;return j.sequencer=i,a&&a.tempo&&(j.tempo=a.tempo),a&&a.instruments&&a.instruments.forEach(function(a){i.instruments[a.name]=new Polyhymnia.Sampler({samples:a.samples})}),{parse:b,play:j.play,stop:j.stop,setParam:h.setParam,setTempo:c,setTonic:e,setScale:f,setTimeSignature:d,setAnimCallback:g}};